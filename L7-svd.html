<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Greg Ridgeway">
<meta name="dcterms.date" content="2025-01-10">

<title>Singular value decomposition</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="L7-svd_files/libs/clipboard/clipboard.min.js"></script>
<script src="L7-svd_files/libs/quarto-html/quarto.js"></script>
<script src="L7-svd_files/libs/quarto-html/popper.min.js"></script>
<script src="L7-svd_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="L7-svd_files/libs/quarto-html/anchor.min.js"></script>
<link href="L7-svd_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="L7-svd_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="L7-svd_files/libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="L7-svd_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="L7-svd_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="L7-svd_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="L7-svd_files/libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#svd-of-an-image" id="toc-svd-of-an-image" class="nav-link" data-scroll-target="#svd-of-an-image"><span class="header-section-number">2</span> SVD of an image</a>
  <ul class="collapse">
  <li><a href="#stewart-in-color" id="toc-stewart-in-color" class="nav-link" data-scroll-target="#stewart-in-color"><span class="header-section-number">2.1</span> Stewart in color</a></li>
  </ul></li>
  <li><a href="#building-an-emoji-classifier" id="toc-building-an-emoji-classifier" class="nav-link" data-scroll-target="#building-an-emoji-classifier"><span class="header-section-number">3</span> Building an emoji classifier</a></li>
  <li><a href="#classification-of-positive-emojis" id="toc-classification-of-positive-emojis" class="nav-link" data-scroll-target="#classification-of-positive-emojis"><span class="header-section-number">4</span> Classification of positive emojis</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">5</span> Summary</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="L7-svd.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Singular value decomposition</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Greg Ridgeway <a href="mailto:gridge@upenn.edu" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Pennsylvania
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 10, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<!-- In terminal -->
<!-- quarto render L7-svd.qmd -->
<!-- quarto render L7-svd.qmd --cache-refresh  -->
<p>Note to Mac users: You will need to have <a href="https://www.xquartz.org/">XQuartz</a> installed if you want to run the code in these notes.</p>
<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>Singular value decomposition (SVD) is a linear algebra technique for factoring a matrix with wide-ranging applications in data science and machine learning.</p>
<p>With natural numbers (1, 2, 3, …) we can find different ways of factoring them. For example, 24 can be factored as <span class="math inline">\(1\times 24\)</span>, <span class="math inline">\(2\times 12\)</span>, <span class="math inline">\(3\times 8\)</span>, and <span class="math inline">\(4\times 6\)</span>. We can also factor a matrix in multiple ways and some factorizations are more useful than others.</p>
<p>The SVD of a <span class="math inline">\(m\times n\)</span> matrix <span class="math inline">\(\mathbf{A}\)</span> is</p>
<p><span id="eq-SVDdefinition"><span class="math display">\[\mathbf{A}=\mathbf{U}\Sigma\mathbf{V}' \tag{1}\]</span></span></p>
<p>where <span class="math inline">\(\mathbf{U}\)</span> is an <span class="math inline">\(m\times m\)</span> square matrix, <span class="math inline">\(\Sigma\)</span> is an <span class="math inline">\(m\times n\)</span> rectangular diagonal matrix (every element is 0 except those on the diagonal starting from the <span class="math inline">\(\sigma_{11}\)</span> element), and <span class="math inline">\(\mathbf{V}\)</span> is an <span class="math inline">\(n\times n\)</span> square matrix. The three matrices, <span class="math inline">\(\mathbf{U}\)</span> , <span class="math inline">\(\Sigma\)</span>, and <span class="math inline">\(\mathbf{V}\)</span>, are constrained to have special properties. The columns of <span class="math inline">\(\mathbf{U}\)</span> and <span class="math inline">\(\mathbf{V}\)</span> have length 1 in the sense that</p>
<p><span class="math display">\[
\sqrt{\sum_{i=1}^m u_{ij}^2}=1 \; \mathrm{and} \; \sqrt{\sum_{i=1}^n v_{ij}^2}=1
\]</span> Also for any column <span class="math inline">\(i\)</span> and columns <span class="math inline">\(j\)</span>, where <span class="math inline">\(i\neq j\)</span>, the dot product of the two columns is 0, <span class="math inline">\(\mathbf{u}_i'\mathbf{u}_j=0\)</span> and <span class="math inline">\(\mathbf{v}_i'\mathbf{v}_j=0\)</span>. Together, these two facts mean</p>
<p><span class="math display">\[
\mathbf{U}'\mathbf{U}=\mathbf{I}\;\mathrm{and}\;\mathbf{V}'\mathbf{V}=\mathbf{I}
\]</span></p>
<p>Lastly, <span class="math inline">\(\Sigma\)</span> only has positive values on the diagonal arranged in decreasing order and 0s in all other entries.</p>
<p>Let’s start with an example. Let</p>
<p><span class="math display">\[
\mathbf{A}=\begin{bmatrix} 1&amp;4\\ 2&amp;5\\ 3&amp;6 \end{bmatrix}
\]</span></p>
<p>In R we can use the built-in function <code>svd()</code> to compute the SVD of <span class="math inline">\(\mathbf{A}\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,<span class="dv">4</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>Asvd <span class="ot">&lt;-</span> <span class="fu">svd</span>(A)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>Asvd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$d
[1] 9.5080320 0.7728696

$u
           [,1]       [,2]
[1,] -0.4286671  0.8059639
[2,] -0.5663069  0.1123824
[3,] -0.7039467 -0.5811991

$v
           [,1]       [,2]
[1,] -0.3863177 -0.9223658
[2,] -0.9223658  0.3863177</code></pre>
</div>
</div>
<p>This output means that <span id="eq-SVDexample1"><span class="math display">\[
\begin{bmatrix}
1 &amp; 4 \\
2 &amp; 5 \\
3 &amp; 6 \\
\end{bmatrix} =
\begin{bmatrix}
-0.429 &amp; 0.806 \\
-0.566 &amp; 0.112 \\
-0.704 &amp; -0.581 \\
\end{bmatrix}
\begin{bmatrix}
9.508 &amp; 0.000 \\
0.000 &amp; 0.773 \\
\end{bmatrix}
\begin{bmatrix}
-0.386 &amp; -0.922 \\
-0.922 &amp; 0.386 \\
\end{bmatrix}'
\tag{2}\]</span></span></p>
<p>We can verify this in R</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(Asvd, u <span class="sc">%*%</span> <span class="fu">diag</span>(d) <span class="sc">%*%</span> <span class="fu">t</span>(v))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2]
[1,]    1    4
[2,]    2    5
[3,]    3    6</code></pre>
</div>
</div>
<p>Earlier I indicated that <span class="math inline">\(\mathbf{U}\)</span> should be an <span class="math inline">\(m\times m\)</span> matrix (<span class="math inline">\(3\times 3\)</span> in this case), but here R gave us a <span class="math inline">\(3\times 2\)</span> matrix. This is because the third column would be all 0s. The same goes for <span class="math inline">\(\Sigma\)</span>. You might have expected a <span class="math inline">\(3\times 3\)</span> matrix here, but the third element would again be 0, so <code>svd()</code> simplifies the results for us. This is often referred to as the “compact SVD”.</p>
<p>The “singular values” are those that run down the diagonal of <span class="math inline">\(\Sigma\)</span> and are placed in descending order. Notice how the <span class="math inline">\(\sigma_{11}\)</span> element is much larger than the second singular value in <span class="math inline">\(\sigma_{22}\)</span>. That implies that the first column of <span class="math inline">\(\mathbf{U}\)</span> and the first column of <span class="math inline">\(\mathbf{V}\)</span> are the most important.</p>
<p>Partially multiplying out these matrices shows an equivalent form <span id="eq-SVDexample2"><span class="math display">\[
\begin{split}
\mathbf{A}&amp;= \sigma_{11}u_{\cdot 1}v_{\cdot 1}' +
            \sigma_{22}u_{\cdot 2}v_{\cdot 2}'\\
&amp;=9.508 \begin{bmatrix}
-0.429 \\
-0.566 \\
-0.704 \\
\end{bmatrix} \begin{bmatrix}
-0.386 &amp; -0.922
\end{bmatrix} +
0.773 \begin{bmatrix}
0.806 \\
0.112 \\
-0.581 \\
\end{bmatrix} \begin{bmatrix}
-0.922 &amp; 0.386
\end{bmatrix} \\
&amp;= 9.508\begin{bmatrix}
0.166 &amp; 0.395 \\
0.219 &amp; 0.522 \\
0.272 &amp; 0.649 \\
\end{bmatrix} +
0.773\begin{bmatrix}
-0.743 &amp; 0.311 \\
-0.104 &amp; 0.043 \\
0.536 &amp; -0.225 \\
\end{bmatrix}
\end{split}
\tag{3}\]</span></span></p>
<p>We can verify this in R</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(Asvd, d[<span class="dv">1</span>]<span class="sc">*</span>u[,<span class="dv">1</span>]<span class="sc">%*%</span><span class="fu">t</span>(v[,<span class="dv">1</span>]) <span class="sc">+</span> d[<span class="dv">2</span>]<span class="sc">*</span>u[,<span class="dv">2</span>]<span class="sc">%*%</span><span class="fu">t</span>(v[,<span class="dv">2</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2]
[1,]    1    4
[2,]    2    5
[3,]    3    6</code></pre>
</div>
</div>
<p>Note that in (<a href="#eq-SVDexample2" class="quarto-xref">3</a>) the first singular value is 12 times larger than the second singular value. This means that the first columns of <span class="math inline">\(\mathbf{U}\)</span> and <span class="math inline">\(\mathbf{V}\)</span> are much more important in reconstructing <span class="math inline">\(\mathbf{A}\)</span> from the SVD components. In fact, this is what makes the SVD so useful. We can take a matrix and focus on the components associated with just the largest singular values and ignore the rest. What happens if we were to ignore the term associated with the 0.773 singular value? We still get a reasonable approximation to <span class="math inline">\(\mathbf{A}\)</span>.</p>
<p><span id="eq-SVDexample3"><span class="math display">\[
\mathbf{A}\approx 9.508\begin{bmatrix}
0.166 &amp; 0.395 \\
0.219 &amp; 0.522 \\
0.272 &amp; 0.649 \\
\end{bmatrix} =
\begin{bmatrix}
1.575 &amp; 3.759 \\
2.080 &amp; 4.966 \\
2.586 &amp; 6.174 \\
\end{bmatrix}
\tag{4}\]</span></span></p>
<p>If you notice, the second column is a multiple of the first column (by a factor of 2.388). By using just the first singular vectors we can compress the information in <span class="math inline">\(\mathbf{A}\)</span>. More precisely, there is no other matrix where one column is a multiple of the other (a matrix of “rank 1”) that matches <span class="math inline">\(\mathbf{A}\)</span> as closely as this one as measured with the sum of the squared differences between their elements. This is known as the <a href="https://en.wikipedia.org/wiki/Low-rank_approximation">Eckart–Young–Mirsky theorem</a>, (re)discovered in 1936.</p>
<p>This property of the SVD, that it decomposes a large matrix into more compact representations, is what makes the SVD valuable in machine learning. We can take complicated objects like sound, images, video, and documents, convert them into a matrix form, and extract the most important features. Rather than needing to handcode specific features (does the sound hit a particular frequency often? does the text include a particular word?, does the photo have a green dot at a specific spot?), the SVD will tell you what the most important features are and place them in descending order of importance. We can use those features for prediction, classification, and clustering. Recommendation systems (Netflix, Amazon, Goodreads) and classifiers (facial recognition, Shazam) use variations on this idea to make their predictions.</p>
<p>We will work through two image problems. First we will work with a single image to learn what SVD does with it and how well it can compress the image. Then we will work with a collection of face emojis to see if we can classify them into “positive” and “non-positive” groups.</p>
</section>
<section id="svd-of-an-image" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> SVD of an image</h1>
<p>I was once told that, for some reason, students are interested in pets. For that reason, I will use Stewart, our pandemic parrot, a blue-crowned conure, as our example image. The <code>imager</code> package includes functionality for importing, manipulating, and displaying PNG, JPEG, and BMP files (other formats are possible but require other software). I will load a picture of Stewart, rotate it 90 degrees clockwise so Stewart is upright, and display the picture.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>stewart <span class="ot">&lt;-</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  imager<span class="sc">::</span><span class="fu">load.image</span>(<span class="st">"data/stewart.jpg"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  imager<span class="sc">::</span><span class="fu">imrotate</span>(<span class="dv">90</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(stewart, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">4000</span>,<span class="dv">0</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">3000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-stewartOriginal" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-stewartOriginal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L7-svd_files/figure-html/fig-stewartOriginal-1.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stewartOriginal-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Stewart the Pandemic Parrot
</figcaption>
</figure>
</div>
</div>
</div>
<p>Make note of the coordinate system. The point (1,1) is in the top left corner of the image.</p>
<p>The <code>stewart</code> image object is a 4-dimensional array.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(stewart)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3024 4032    1    3</code></pre>
</div>
</div>
<p>It is 3024 pixels wide, 4032 pixels tall, includes only 1 frame (not a video with multiple frames), and 3 color channels (red, green, and blue). We can separate out each of these red, green, and blue layers to see them separately. Mixing the three images shown in <a href="#fig-stewartRGB" class="quarto-xref">Figure&nbsp;2</a> will reproduce the original Stewart.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>), <span class="at">mai=</span><span class="fu">rep</span>(<span class="fl">0.1</span>,<span class="dv">4</span>))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>stewartTemp <span class="ot">&lt;-</span> stewart</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>stewartTemp[,,,<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(stewartTemp, <span class="at">axes=</span><span class="cn">FALSE</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>stewartTemp <span class="ot">&lt;-</span> stewart</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>stewartTemp[,,,<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(stewartTemp, <span class="at">axes=</span><span class="cn">FALSE</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>stewartTemp <span class="ot">&lt;-</span> stewart</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>stewartTemp[,,,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(stewartTemp, <span class="at">axes=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-stewartRGB" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-stewartRGB-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L7-svd_files/figure-html/fig-stewartRGB-1.png" class="img-fluid figure-img" width="1400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stewartRGB-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Stewart shown in each of the three color channels
</figcaption>
</figure>
</div>
</div>
</div>
<p>We will work through a color image in a moment, but to simplify let’s start with a grayscale version of Stewart. This will convert the image to a single <span class="math inline">\(3024\times 4032\)</span> matrix with values ranging from 0 to 1, with 0 indicating black and 1 indicating white.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai=</span><span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>stewartGray <span class="ot">&lt;-</span> imager<span class="sc">::</span><span class="fu">grayscale</span>(stewart)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(stewartGray, <span class="at">axes=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-stewartGray" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-stewartGray-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L7-svd_files/figure-html/fig-stewartGray-1.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stewartGray-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Stewart shown in grayscale
</figcaption>
</figure>
</div>
</div>
</div>
<p>We can peek at the top left corner to see what this looks like.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>stewartGray[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]      [,2]      [,3]      [,4]      [,5]
[1,] 0.4393333 0.4275686 0.4247843 0.4429412 0.4429020
[2,] 0.4275686 0.4287059 0.4326275 0.4390196 0.4389804
[3,] 0.4365490 0.4287059 0.4247843 0.4272549 0.4311373
[4,] 0.4443922 0.4287059 0.4247843 0.4232941 0.4232941
[5,] 0.4326275 0.4302745 0.4420392 0.4389804 0.4232941</code></pre>
</div>
</div>
<p>These are the <span class="math inline">\(5\times 5\)</span> set of pixels in the upper left corner of the image indicating a mildly dark gray in that region.</p>
<p>Time to throw SVD at this matrix to see if we can approximate this image with some lower rank matrices. Here I am using the <code>fastSVD</code> function from the <code>bootSVD</code> package because… well… it is fast. In addition, it allows the user to not return the full set of singular vectors/values to obtain a smaller result. Here I ask for only the largest 100 singular values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># limit computation to just 100 singular values</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>stewSVD <span class="ot">&lt;-</span> bootSVD<span class="sc">::</span><span class="fu">fastSVD</span>(stewartGray[,,<span class="dv">1</span>,<span class="dv">1</span>], <span class="at">nv=</span><span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s explore what we have in <code>stewSVD</code> by checking the dimensions of <span class="math inline">\(\mathbf{U}\)</span>, <span class="math inline">\(\Sigma\)</span>, and <span class="math inline">\(\mathbf{V}\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(stewSVD<span class="sc">$</span>u)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3024 3024</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(stewSVD<span class="sc">$</span>d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3024</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(stewSVD<span class="sc">$</span>v)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4032  100</code></pre>
</div>
</div>
<p>So <span class="math inline">\(\mathbf{U}\)</span> is a <span class="math inline">\(3024\times3024\)</span> matrix and <span class="math inline">\(\mathbf{V}\)</span> is a <span class="math inline">\(4032\times100\)</span> matrix, limited to 100 columns by the <code>nv=100</code> argument when we ran <code>fastSVD</code>. <code>stewSVD$d</code> stores just the diagonal elements of <span class="math inline">\(\Sigma\)</span> with R reporting that there are 3024 singular values computed. Let’s explore the singular values graphically.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">scipen=</span><span class="dv">1000</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(stewSVD<span class="sc">$</span>d, <span class="at">type=</span><span class="st">"l"</span>, <span class="at">log=</span><span class="st">"y"</span>, </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Singular value order"</span>,<span class="at">ylab=</span><span class="st">"Singular values"</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">100</span><span class="sc">*</span><span class="fu">cumsum</span>(stewSVD<span class="sc">$</span>d)<span class="sc">/</span><span class="fu">sum</span>(stewSVD<span class="sc">$</span>d), </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">type=</span><span class="st">"l"</span>, </span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">100</span>),</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"Singular value order"</span>,<span class="at">ylab=</span><span class="st">"Cumulative % of singular value sum"</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="fl">0.9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-singularvalues" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-singularvalues-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L7-svd_files/figure-html/fig-singularvalues-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-singularvalues-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Distribution of the singular values
</figcaption>
</figure>
</div>
</div>
</div>
<p>The left plot in <a href="#fig-singularvalues" class="quarto-xref">Figure&nbsp;4</a> shows that the largest singular values are very large (note that the y-axis on in the log scale). The largest is 1801.2 and there are 5 singular values that exceed 100. Then the singular values decrease rather quickly with the smallest singular values near 0. The right plot in <a href="#fig-singularvalues" class="quarto-xref">Figure&nbsp;4</a> shows the cumulative percentage of the total sum of the singular values. That is, the sum of all the singular values is 11029.8. The first 824 singular values sum to 90% of this total. This has a direct interpretation in terms of the variance explained in the original image. The first 824 singular vectors explain 90% of the variance in the values. Perfectly reconstructing the image requires all of the singular vectors, but we can nearly reconstruct it with many fewer. This is what image compression aims to do.</p>
<p>Let’s check some other properties. The sum of squares of every column in <span class="math inline">\(\mathbf{U}\)</span> and <span class="math inline">\(\mathbf{V}\)</span> should be 1 and the dot product of two different columns should be 0. Let’s check with a few columns.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(stewSVD<span class="sc">$</span>u[,<span class="dv">1</span>]<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(stewSVD<span class="sc">$</span>u[,<span class="dv">100</span>]<span class="sc">^</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(stewSVD<span class="sc">$</span>u[,<span class="dv">123</span>] <span class="sc">*</span> stewSVD<span class="sc">$</span>u[,<span class="dv">1234</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.00000000000000002270853</code></pre>
</div>
</div>
<p>You can run similar checks for <code>stewSVD$v</code>. More generally, <span class="math inline">\(\mathbf{U}'\mathbf{U}=\mathbf{I}\)</span>, <span class="math inline">\(\mathbf{U}\mathbf{U}'=\mathbf{I}\)</span>, <span class="math inline">\(\mathbf{V}'\mathbf{V}=\mathbf{I}\)</span>, and <span class="math inline">\(\mathbf{V}\mathbf{V}'=\mathbf{I}\)</span>. I use <code>zapsmall()</code> so that values like 0.99999999 and 1e-17 are rounded to 1 and 0.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">t</span>(stewSVD<span class="sc">$</span>u[,<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]) <span class="sc">%*%</span> stewSVD<span class="sc">$</span>u[,<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>] <span class="sc">|&gt;</span> <span class="fu">zapsmall</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
 [1,]    1    0    0    0    0    0    0    0    0     0
 [2,]    0    1    0    0    0    0    0    0    0     0
 [3,]    0    0    1    0    0    0    0    0    0     0
 [4,]    0    0    0    1    0    0    0    0    0     0
 [5,]    0    0    0    0    1    0    0    0    0     0
 [6,]    0    0    0    0    0    1    0    0    0     0
 [7,]    0    0    0    0    0    0    1    0    0     0
 [8,]    0    0    0    0    0    0    0    1    0     0
 [9,]    0    0    0    0    0    0    0    0    1     0
[10,]    0    0    0    0    0    0    0    0    0     1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>stewSVD<span class="sc">$</span>u[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,] <span class="sc">%*%</span> <span class="fu">t</span>(stewSVD<span class="sc">$</span>u[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,]) <span class="sc">|&gt;</span> <span class="fu">zapsmall</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
 [1,]    1    0    0    0    0    0    0    0    0     0
 [2,]    0    1    0    0    0    0    0    0    0     0
 [3,]    0    0    1    0    0    0    0    0    0     0
 [4,]    0    0    0    1    0    0    0    0    0     0
 [5,]    0    0    0    0    1    0    0    0    0     0
 [6,]    0    0    0    0    0    1    0    0    0     0
 [7,]    0    0    0    0    0    0    1    0    0     0
 [8,]    0    0    0    0    0    0    0    1    0     0
 [9,]    0    0    0    0    0    0    0    0    1     0
[10,]    0    0    0    0    0    0    0    0    0     1</code></pre>
</div>
</div>
<p>All the properties that we expect of the SVD appear to hold. Now let’s see if it can really reconstruct the image of Stewart with few singular vectors (or at least much less that 3024).</p>
<p>Let’s start by looking at what Stewart looks like with just one singular value.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai=</span><span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>))</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> stewSVD<span class="sc">$</span>d[<span class="dv">1</span>] <span class="sc">*</span> stewSVD<span class="sc">$</span>u[,<span class="dv">1</span>] <span class="sc">%*%</span> <span class="fu">t</span>(stewSVD<span class="sc">$</span>v[,<span class="dv">1</span>])</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>a <span class="sc">|&gt;</span> </span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  imager<span class="sc">::</span><span class="fu">as.cimg</span>() <span class="sc">|&gt;</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="at">axes=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-stew1SV" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-stew1SV-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L7-svd_files/figure-html/fig-stew1SV-1.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stew1SV-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Stewart with one singular value
</figcaption>
</figure>
</div>
</div>
</div>
<p><a href="#fig-stew1SV" class="quarto-xref">Figure&nbsp;5</a> does not look like much. It really only captures the idea that the top half of the image is dark and the lower half is light.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">mai=</span><span class="fu">rep</span>(<span class="fl">0.1</span>,<span class="dv">4</span>))</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(numSV <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">50</span>,<span class="dv">100</span>))</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">&lt;-</span> stewSVD<span class="sc">$</span>u[,<span class="dv">1</span><span class="sc">:</span>numSV] <span class="sc">%*%</span> </span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>          <span class="fu">diag</span>(stewSVD<span class="sc">$</span>d[<span class="dv">1</span><span class="sc">:</span>numSV]) <span class="sc">%*%</span> </span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>          <span class="fu">t</span>(stewSVD<span class="sc">$</span>v[,<span class="dv">1</span><span class="sc">:</span>numSV])</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">|&gt;</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    imager<span class="sc">::</span><span class="fu">as.cimg</span>() <span class="sc">|&gt;</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(<span class="at">axes=</span><span class="cn">FALSE</span>, </span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">main=</span><span class="fu">paste</span>(numSV,<span class="st">"singular vectors"</span>))</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(stewartGray, <span class="at">axes=</span><span class="cn">FALSE</span>, <span class="at">main=</span><span class="st">"Original"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-stewSV" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-stewSV-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L7-svd_files/figure-html/fig-stewSV-1.png" class="img-fluid figure-img" width="1400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stewSV-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Stewarts with different rank reconstructions (2, 10, 20, 50, 100, and 3024)
</figcaption>
</figure>
</div>
</div>
</div>
<p><a href="#fig-stewSV" class="quarto-xref">Figure&nbsp;6</a> shows just how much image information is in those first few singular vectors. Two singular vectors is definitely not enough. By 10 singular vectors you can already tell that there is a bird like shape in the picture. You really do not need more than 20 to know that there is bird perched on a container with flowers. The image based on 100 singular vectors is hard to distinguish from the original.</p>
<section id="stewart-in-color" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="stewart-in-color"><span class="header-section-number">2.1</span> Stewart in color</h2>
<p>To compress a color image of Stewart we can either apply SVD separately on each color channel or merge them into a single matrix and apply one SVD. We are going to do the latter. This allows SVD to share information across the color channels.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>stewartTemp <span class="ot">&lt;-</span> stewart</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"># put the colors side by side</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">cbind</span>(stewart[,,,<span class="dv">1</span>], stewart[,,,<span class="dv">2</span>], stewart[,,,<span class="dv">3</span>])</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"># This SVD can take about 2 minutes</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>stewSVD <span class="ot">&lt;-</span> bootSVD<span class="sc">::</span><span class="fu">fastSVD</span>(a, <span class="dv">100</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co"># reconstruct Stewart in color using 100 singular values</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>numSV <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> stewSVD<span class="sc">$</span>u[,<span class="dv">1</span><span class="sc">:</span>numSV] <span class="sc">%*%</span> </span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">diag</span>(stewSVD<span class="sc">$</span>d[<span class="dv">1</span><span class="sc">:</span>numSV]) <span class="sc">%*%</span> </span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">t</span>(stewSVD<span class="sc">$</span>v[,<span class="dv">1</span><span class="sc">:</span>numSV])</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="co"># put them back into their RGB format</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>stewartTemp[,,,<span class="dv">1</span>] <span class="ot">&lt;-</span> a[,<span class="dv">1</span><span class="sc">:</span><span class="dv">4032</span> <span class="sc">+</span> <span class="dv">0</span><span class="sc">*</span><span class="dv">4032</span>]</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>stewartTemp[,,,<span class="dv">2</span>] <span class="ot">&lt;-</span> a[,<span class="dv">1</span><span class="sc">:</span><span class="dv">4032</span> <span class="sc">+</span> <span class="dv">1</span><span class="sc">*</span><span class="dv">4032</span>]</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>stewartTemp[,,,<span class="dv">3</span>] <span class="ot">&lt;-</span> a[,<span class="dv">1</span><span class="sc">:</span><span class="dv">4032</span> <span class="sc">+</span> <span class="dv">2</span><span class="sc">*</span><span class="dv">4032</span>]</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai=</span><span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>))</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>stewartTemp <span class="sc">|&gt;</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>  imager<span class="sc">::</span><span class="fu">as.cimg</span>() <span class="sc">|&gt;</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="at">axes=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-stewColor" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-stewColor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L7-svd_files/figure-html/fig-stewColor-1.png" class="img-fluid figure-img" width="800">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stewColor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Stewart in color, 100 singular vectors
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="building-an-emoji-classifier" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Building an emoji classifier</h1>
<p>In the previous section we explored working with a single image stored as a matrix. In practice we are going to have a collection of sounds, images, videos, or documents. We most likely will want to either make some kind of prediction about them or cluster them into groups.</p>
<p>For some practice applying the SVD, I will acquire a dataset of 91 face emojis, label them as either “positive” or “not positive”, and then build a classifier on each emoji’s right singular vectors to see if we can separate the positive from non-positive face emojis. I use the emojis because 1) the images are not very large and 2) we can visualize what the SVD is doing.</p>
<p>To acquire the emojis I ran the following R script. This code downloads all the face emojis from “grinning face” to “angry face with horns”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="st">"grinning-face"</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">885</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>urlRoot <span class="ot">&lt;-</span> <span class="st">"https://s3.amazonaws.com/pix.iemoji.com/images/emoji/apple/ios-12/256/"</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="cf">repeat</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download.file</span>(<span class="fu">paste0</span>(urlRoot,x,<span class="st">".png"</span>), </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>                <span class="fu">paste0</span>(<span class="st">"data/emojis/"</span>,x,<span class="st">".png"</span>), <span class="at">mode=</span><span class="st">"wb"</span>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(x<span class="sc">==</span><span class="st">"angry-face-with-horns"</span>) <span class="cf">break</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get the link to the next emoji</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  a <span class="ot">&lt;-</span> <span class="fu">scan</span>(<span class="fu">paste0</span>(<span class="st">"https://www.iemoji.com/view/emoji/"</span>,y,<span class="st">"/smileys-people/"</span>, x),</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">sep=</span><span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">what=</span><span class="st">""</span>)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">&lt;-</span> <span class="fu">grep</span>(<span class="st">"customNextBtn"</span>, a, <span class="at">value =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>          <span class="fu">gsub</span>(<span class="st">'.*href="/view/emoji/([^"]*)".*'</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="at">x=</span>_)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"^.*/"</span>, <span class="st">""</span>, b)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"/.*"</span>, <span class="st">""</span>, b)</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I then went and looked at each of the 91 emojis and rated them as being either positive (<span class="math inline">\(y=1\)</span>) or not positive (<span class="math inline">\(y=0\)</span>). You may disagree on my labelings and you are welcome to change them or, even better, create your own characteristic to predict. Note that many of the emojis that I labeled non-positive are simply neutral. To label the emojis I ran the following R code that displays an emoji, waits for me to enter 0 or 1, and then moves on to the next emoji.</p>
<!-- No need to actually run this here. I load in the y labels next -->
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"data/emojis/"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(a))</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(a))</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(imager<span class="sc">::</span><span class="fu">load.image</span>(a[[i]]), <span class="at">axes=</span><span class="cn">FALSE</span>)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>  y[i] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">readline</span>())</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- This loads in the y labels I created by hand -->
<p>We are ready to read in all the emojis and store them in a data matrix.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"data/emojis/"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>nEmoji <span class="ot">&lt;-</span> <span class="fu">length</span>(a)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># emojis are 256 tall x 256 wide x 3 colors</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># X will be about 200,000 x 91</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow=</span><span class="dv">256</span><span class="sc">*</span><span class="dv">256</span><span class="sc">*</span><span class="dv">3</span>, <span class="at">ncol=</span>nEmoji)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nEmoji)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">&lt;-</span> imager<span class="sc">::</span><span class="fu">load.image</span>(a[i])</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># as.numeric() turns 3D array into single long column</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   goes down red channel columns, then green, then blue</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>  X[,i] <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(b)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First let’s see how big this data matrix <code>X</code> is.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 196608     91</code></pre>
</div>
</div>
<p>We have 91 emojis each stored in their own columns. Each emoji is has <span class="math inline">\(256\times 256=65,536\)</span> pixels with 3 color channels each for a total of 196,608 values.</p>
<p>To display an emoji from one of the columns, say column 19, we can convert <code>X[,19]</code> back into a 3D array of dimensions 256, 256, 1 (single frame/not video), 3, and use <code>as.cimg()</code> to make R understand that it’s an emoji.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>X[,<span class="dv">19</span>] <span class="sc">|&gt;</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">array</span>(<span class="at">dim=</span><span class="fu">c</span>(<span class="dv">256</span>,<span class="dv">256</span>,<span class="dv">1</span>,<span class="dv">3</span>)) <span class="sc">|&gt;</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  imager<span class="sc">::</span><span class="fu">as.cimg</span>() <span class="sc">|&gt;</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="at">axes=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-exampleEmoji" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-exampleEmoji-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L7-svd_files/figure-html/fig-exampleEmoji-1.png" class="img-fluid figure-img" width="1400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-exampleEmoji-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Example emoji stored in column 19 of <code>X</code>
</figcaption>
</figure>
</div>
</div>
</div>
<p>These are the ones I have labeled as “positive” emojis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">6</span>,<span class="dv">6</span>), <span class="at">mai=</span><span class="fu">rep</span>(<span class="fl">0.1</span>,<span class="dv">4</span>))</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">which</span>(y<span class="sc">==</span><span class="dv">1</span>))</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  X[,i] <span class="sc">|&gt;</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">array</span>(<span class="at">dim=</span><span class="fu">c</span>(<span class="dv">256</span>,<span class="dv">256</span>,<span class="dv">1</span>,<span class="dv">3</span>)) <span class="sc">|&gt;</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    imager<span class="sc">::</span><span class="fu">as.cimg</span>() <span class="sc">|&gt;</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(<span class="at">axes=</span><span class="cn">FALSE</span>)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-positiveEmojis" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-positiveEmojis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L7-svd_files/figure-html/fig-positiveEmojis-1.png" class="img-fluid figure-img" width="1400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-positiveEmojis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: All emojis labeled positive
</figcaption>
</figure>
</div>
</div>
</div>
<p>And here are all the emojis that I have labeled as “not positive”.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">7</span>), <span class="at">mai=</span><span class="fu">rep</span>(<span class="fl">0.1</span>,<span class="dv">4</span>))</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">which</span>(y<span class="sc">==</span><span class="dv">0</span>))</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  X[,i] <span class="sc">|&gt;</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">array</span>(<span class="at">dim=</span><span class="fu">c</span>(<span class="dv">256</span>,<span class="dv">256</span>,<span class="dv">1</span>,<span class="dv">3</span>)) <span class="sc">|&gt;</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    imager<span class="sc">::</span><span class="fu">as.cimg</span>() <span class="sc">|&gt;</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(<span class="at">axes=</span><span class="cn">FALSE</span>)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-notpositiveEmojis" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-notpositiveEmojis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L7-svd_files/figure-html/fig-notpositiveEmojis-1.png" class="img-fluid figure-img" width="1400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-notpositiveEmojis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: All emojis labeled non-positive
</figcaption>
</figure>
</div>
</div>
</div>
<p>Now let’s apply the SVD to <code>X</code> and inspect the size of the resulting <span class="math inline">\(\mathbf{U}\)</span> and <span class="math inline">\(\mathbf{V}\)</span> components of the SVD.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 seconds</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>svdEmoji <span class="ot">&lt;-</span> bootSVD<span class="sc">::</span><span class="fu">fastSVD</span>(X)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(svdEmoji<span class="sc">$</span>u)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 196608     91</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(svdEmoji<span class="sc">$</span>v)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 91 91</code></pre>
</div>
</div>
<p>The columns of <code>u</code> contain the “eigenemojis”. “eigen” is a German prefix for “characteristic”. These are the foundational ingredients in creating any of the 91 face emojis. You can create any of the emojis shown in <a href="#fig-positiveEmojis" class="quarto-xref">Figure&nbsp;9</a> and <a href="#fig-notpositiveEmojis" class="quarto-xref">Figure&nbsp;10</a> with a linear combination of the 91 eigenemojis in <code>u</code>. Row <span class="math inline">\(i\)</span> of <span class="math inline">\(\Sigma\mathbf{V}'\)</span> gives us the exact coefficients needed to mix the columns of <span class="math inline">\(\mathbf{U}\)</span> to reconstruct emoji <span class="math inline">\(i\)</span>. As with the image of Stewart, there are few important left singular vectors and several that are not very important. <a href="#fig-svEmojis" class="quarto-xref">Figure&nbsp;11</a> plots the singular values, showing a pattern similar to the one we saw for Stewart in <a href="#fig-singularvalues" class="quarto-xref">Figure&nbsp;4</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(svdEmoji<span class="sc">$</span>d, <span class="at">log=</span><span class="st">"y"</span>, <span class="at">type=</span><span class="st">"l"</span>, <span class="at">ylab=</span><span class="st">"Singular values"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-svEmojis" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-svEmojis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L7-svd_files/figure-html/fig-svEmojis-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-svEmojis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: Plot of the singular values
</figcaption>
</figure>
</div>
</div>
</div>
<p>Let’s take a look at these so-called eigenemojis. Note that I multiply the <span class="math inline">\(\mathbf{U}_{\cdot j}\)</span> by -1 to reverse the colors so they look more familiar. The SVD factorization does not change if the signs on <span class="math inline">\(\mathbf{U}\)</span> and <span class="math inline">\(\mathbf{V}\)</span> are changed, <span class="math inline">\(\mathbf{U}\Sigma\mathbf{V}'=(-\mathbf{U})\Sigma(-\mathbf{V}')\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">mai=</span><span class="fu">rep</span>(<span class="fl">0.1</span>,<span class="dv">4</span>))</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>) </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span>svdEmoji<span class="sc">$</span>u[,j] <span class="sc">|&gt;</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">array</span>(<span class="at">dim=</span><span class="fu">c</span>(<span class="dv">256</span>,<span class="dv">256</span>,<span class="dv">1</span>,<span class="dv">3</span>)) <span class="sc">|&gt;</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>     imager<span class="sc">::</span><span class="fu">as.cimg</span>() <span class="sc">|&gt;</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>     <span class="fu">plot</span>(<span class="at">axes=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-eigenEmojis" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-eigenEmojis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L7-svd_files/figure-html/fig-eigenEmojis-1.png" class="img-fluid figure-img" width="1400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-eigenEmojis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: The first six eigenemojis
</figcaption>
</figure>
</div>
</div>
</div>
<p>The first eigenemoji in the top left, captures the most important foundational feature of these emojis, a generally round shape with some eye and mouth structure. The next five begin to capture other features that show up in multiple emojis like horns, teeth, different shades, tongues, and bigger eyes.</p>
<p>To reconstruct an emoji, we need to know how to mix the 91 eigenemojis together. <span class="math inline">\(\Sigma\mathbf{V}_{i\cdot}'\)</span> tells us how much of each eigenemoji to add to the mixture to get emoji <span class="math inline">\(i\)</span> created. For emoji 19 that mixture is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(svdEmoji<span class="sc">$</span>d) <span class="sc">%*%</span> svdEmoji<span class="sc">$</span>v[<span class="dv">19</span>,] <span class="sc">|&gt;</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.numeric</span>() <span class="sc">|&gt;</span> </span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] -318.9   57.4  -24.6  -70.3  -32.8   -3.5  -10.1   21.4  -14.2  -39.0
[11]  -19.4   16.2   43.8   14.7   10.4    3.2   -7.4   18.3   12.9   -2.2
[21]    9.9  -11.1    9.4   -2.4   -5.8   -5.8    3.4   -7.8  -10.0   -7.6
[31]    0.5  -15.4   -1.1    9.9    6.5    0.5    6.2    2.4    2.9    0.7
[41]    5.7    2.6    4.5   -5.9   -0.1    2.2   -1.7   -0.9    1.1   -7.1
[51]   -2.3    3.7    0.0    3.5   -2.0   -2.2    1.2    2.1    0.0   -0.3
[61]   -0.8    0.3    0.3   -0.9    0.3    0.3    0.9    1.2   -0.9    0.3
[71]    1.2    0.1    0.1   -0.3    1.2    0.2   -0.3    0.2   -0.2    0.3
[81]   -0.5   -0.3   -0.1    0.0    0.0    0.0   -0.1    0.1    0.1    0.0
[91]    0.0</code></pre>
</div>
</div>
<p>So if we literally multiply the first column of <code>svdEmoji$u</code> by -318.9 and add it to the second column of <code>svdEmoji$u</code> multiplied by 57.4 and so on, then we can rebuild emoji 19.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>A <span class="ot">&lt;-</span> svdEmoji<span class="sc">$</span>u <span class="sc">%*%</span> <span class="fu">diag</span>(svdEmoji<span class="sc">$</span>d) <span class="sc">%*%</span> svdEmoji<span class="sc">$</span>v[<span class="dv">19</span>,]</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>A <span class="sc">|&gt;</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">array</span>(<span class="at">dim=</span><span class="fu">c</span>(<span class="dv">256</span>,<span class="dv">256</span>,<span class="dv">1</span>,<span class="dv">3</span>)) <span class="sc">|&gt;</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  imager<span class="sc">::</span><span class="fu">as.cimg</span>() <span class="sc">|&gt;</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="at">axes=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-emoji19reconstructed" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-emoji19reconstructed-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L7-svd_files/figure-html/fig-emoji19reconstructed-1.png" class="img-fluid figure-img" width="1400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-emoji19reconstructed-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13: Emoji 19 reconstructed
</figcaption>
</figure>
</div>
</div>
</div>
<p>But do we really need all of the singular vectors to construct emoji 19? We can see in <a href="#fig-svEmojis" class="quarto-xref">Figure&nbsp;11</a> that only the first 15 or so singular values are large and the last singular values are quite small. Do a few singular vectors carry a lot of the information about the emoji shape and color?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">4</span>), <span class="at">mai=</span><span class="fu">rep</span>(<span class="fl">0.1</span>,<span class="dv">4</span>))</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(numSV <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">50</span>,<span class="dv">15</span>,<span class="dv">10</span>,<span class="dv">5</span>)) </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> svdEmoji<span class="sc">$</span>u[,<span class="dv">1</span><span class="sc">:</span>numSV] <span class="sc">%*%</span> </span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>          <span class="fu">diag</span>(svdEmoji<span class="sc">$</span>d[<span class="dv">1</span><span class="sc">:</span>numSV]) <span class="sc">%*%</span> </span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>          svdEmoji<span class="sc">$</span>v[<span class="dv">19</span>,<span class="dv">1</span><span class="sc">:</span>numSV]</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  A <span class="sc">|&gt;</span> </span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">array</span>(<span class="at">dim=</span><span class="fu">c</span>(<span class="dv">256</span>,<span class="dv">256</span>,<span class="dv">1</span>,<span class="dv">3</span>)) <span class="sc">|&gt;</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    imager<span class="sc">::</span><span class="fu">as.cimg</span>() <span class="sc">|&gt;</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(<span class="at">main=</span><span class="fu">paste</span>(numSV,<span class="st">"singular vectors"</span>), </span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">axes=</span><span class="cn">FALSE</span>)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-emoji19reducedSVs" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-emoji19reducedSVs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L7-svd_files/figure-html/fig-emoji19reducedSVs-1.png" class="img-fluid figure-img" width="1400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-emoji19reducedSVs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;14: Emoji 19 reconstructed with fewer singular vectors
</figcaption>
</figure>
</div>
</div>
</div>
<p>With 50 singular vectors the emoji looks almost the same as when we used all 91 (<a href="#fig-emoji19reconstructed" class="quarto-xref">Figure&nbsp;13</a>). With 15 singular vectors, the emoji is still clearly the scream emoji, but with some light noisy features added. With 10 singular vectors the scream emoji is still evident. Maybe when we are down to only 5 singular vectors it becomes difficult to tell what emoji this is. This implies that with only 15 numbers we can pretty much determine, which emoji those few numbers describe. We do not need to know the color value of all 65,536 pixels, but only 15 numbers.</p>
<p>Those 15 numbers are stored in the first 15 columns of <span class="math inline">\(\mathbf{V}\)</span>. We can find two emojis that are “closest” to each other by finding the two rows of <span class="math inline">\(\mathbf{V}\)</span> that are most similar.</p>
<p>Let’s start by just plotting out the emojis based on the first two right singular vectors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">0</span>,<span class="dv">0</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.11</span>,<span class="sc">-</span><span class="fl">0.07</span>), <span class="at">ylim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">0.1</span>,<span class="fl">0.6</span>), <span class="at">type=</span><span class="st">"n"</span>,</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab=</span><span class="st">"First right singular vector"</span>,</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab=</span><span class="st">"Second right singular vector"</span>)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>width <span class="ot">&lt;-</span> <span class="fl">0.0015</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>aspRatio <span class="ot">&lt;-</span> (<span class="fu">par</span>(<span class="st">"pin"</span>)[<span class="dv">1</span>] <span class="sc">/</span> <span class="fu">diff</span>(<span class="fu">par</span>(<span class="st">"usr"</span>)[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])) <span class="sc">/</span> </span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>            (<span class="fu">par</span>(<span class="st">"pin"</span>)[<span class="dv">2</span>] <span class="sc">/</span> <span class="fu">diff</span>(<span class="fu">par</span>(<span class="st">"usr"</span>)[<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>]))</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(X))</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  A <span class="ot">&lt;-</span> X[,i] <span class="sc">|&gt;</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">array</span>(<span class="at">dim=</span><span class="fu">c</span>(<span class="dv">256</span>,<span class="dv">256</span>,<span class="dv">1</span>,<span class="dv">3</span>)) <span class="sc">|&gt;</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    imager<span class="sc">::</span><span class="fu">as.cimg</span>() <span class="sc">|&gt;</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.raster</span>(A)</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>  A[,] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(A[,],<span class="st">"88"</span>) <span class="co"># make emojis a little transparent</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>  A[A<span class="sc">==</span><span class="st">"#FFFFFF88"</span>] <span class="ot">&lt;-</span> <span class="st">"#FFFFFF00"</span> <span class="co"># turn white completely transparent</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>  coord <span class="ot">&lt;-</span> svdEmoji<span class="sc">$</span>v[i,<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rasterImage</span>(A, coord[<span class="dv">1</span>], coord[<span class="dv">2</span>], coord[<span class="dv">1</span>]<span class="sc">+</span>width, coord[<span class="dv">2</span>]<span class="sc">+</span>width<span class="sc">*</span>aspRatio,</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>              <span class="at">angle=</span><span class="dv">270</span>)</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-2DEmojiPlot" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-2DEmojiPlot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L7-svd_files/figure-html/fig-2DEmojiPlot-1.png" class="img-fluid figure-img" width="1400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-2DEmojiPlot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15: Similarity of emojis based on the first two right singular vectors
</figcaption>
</figure>
</div>
</div>
</div>
<p>In <a href="#fig-2DEmojiPlot" class="quarto-xref">Figure&nbsp;15</a> similar emojis are close to each other and the ones that are quite different are more distant. This is the best we can do to visualize the emojis in two dimensions, but we can compute distances between emojis using more than two right singular vectors. Let’s use the first 15 to find the closest two emojis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>D <span class="ot">&lt;-</span> <span class="fu">dist</span>(svdEmoji<span class="sc">$</span>v[,<span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>])</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co"># show the distances between the first 5 emojis</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">as.matrix</span>(D)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          1         2         3         4         5
1 0.0000000 0.6881778 0.7547505 0.7091763 1.0019791
2 0.6881778 0.0000000 0.2419121 0.2200797 0.8888527
3 0.7547505 0.2419121 0.0000000 0.2842519 0.8784416
4 0.7091763 0.2200797 0.2842519 0.0000000 0.8599961
5 1.0019791 0.8888527 0.8784416 0.8599961 0.0000000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">as.matrix</span>(D)<span class="sc">==</span><span class="fu">min</span>(D), <span class="at">arr.ind=</span><span class="cn">TRUE</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="co"># which two emojis are closest?</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>i[<span class="dv">1</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>row col 
 85  80 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show V for these two emojis</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>svdEmoji<span class="sc">$</span>v[i[<span class="dv">1</span>,],<span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>] <span class="sc">|&gt;</span> <span class="fu">round</span>(<span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1]  [,2] [,3]  [,4] [,5] [,6] [,7]  [,8]  [,9] [,10] [,11] [,12] [,13]
[1,] -0.11 -0.04 0.08 -0.06 0.04 0.08 0.01 -0.06 -0.06  0.03 -0.06 -0.04 -0.01
[2,] -0.11 -0.04 0.07 -0.05 0.04 0.08 0.01 -0.06 -0.05  0.02 -0.08 -0.05 -0.03
     [,14] [,15]
[1,] -0.05  0.01
[2,] -0.05  0.01</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">mai=</span><span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.5</span>,<span class="fl">0.1</span>))</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(j <span class="cf">in</span> i[<span class="dv">1</span>,]) </span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  X[,j] <span class="sc">|&gt;</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">array</span>(<span class="at">dim=</span><span class="fu">c</span>(<span class="dv">256</span>,<span class="dv">256</span>,<span class="dv">1</span>,<span class="dv">3</span>)) <span class="sc">|&gt;</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>    imager<span class="sc">::</span><span class="fu">as.cimg</span>() <span class="sc">|&gt;</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(<span class="at">main=</span><span class="fu">paste</span>(<span class="st">"Emoji"</span>,j), </span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">axes=</span><span class="cn">FALSE</span>)</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-closestEmojis" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-closestEmojis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L7-svd_files/figure-html/fig-closestEmojis-1.png" class="img-fluid figure-img" width="1400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-closestEmojis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;16: The two most similar emojis
</figcaption>
</figure>
</div>
</div>
</div>
<p>This makes sense, right? Because these emojis are so similar, they use almost the same mixture of eigenemojis in their construction. Curious which ones are the farthest apart?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">as.matrix</span>(D)<span class="sc">==</span><span class="fu">max</span>(D), <span class="at">arr.ind=</span><span class="cn">TRUE</span>)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="at">mai=</span><span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.5</span>,<span class="fl">0.1</span>))</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(j <span class="cf">in</span> i[<span class="dv">1</span>,]) </span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  X[,j] <span class="sc">|&gt;</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">array</span>(<span class="at">dim=</span><span class="fu">c</span>(<span class="dv">256</span>,<span class="dv">256</span>,<span class="dv">1</span>,<span class="dv">3</span>)) <span class="sc">|&gt;</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>    imager<span class="sc">::</span><span class="fu">as.cimg</span>() <span class="sc">|&gt;</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(<span class="at">main=</span><span class="fu">paste</span>(<span class="st">"Emoji"</span>,j), <span class="at">axes=</span><span class="cn">FALSE</span>)</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-farEmojis" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-farEmojis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L7-svd_files/figure-html/fig-farEmojis-1.png" class="img-fluid figure-img" width="1400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-farEmojis-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;17: The two emojis farthest apart
</figcaption>
</figure>
</div>
</div>
</div>
<p>I suppose that checks out.</p>
</section>
<section id="classification-of-positive-emojis" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Classification of positive emojis</h1>
<p>Now let’s see if we can use an image’s right singular vectors to predict what kind of emoji it is. Recall I had labeled each emoji as being “positive” (smiles, kisses, laughing, silly) or “not positive” (everything else). I have those 0/1 labels stored in <code>y</code>. I will create a data frame combining <code>y</code> with the first 15 right singular vectors and fit a simple logistic regression model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>numSV <span class="ot">&lt;-</span> <span class="dv">15</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>dEmoji <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">y=</span>y, <span class="at">u=</span>svdEmoji<span class="sc">$</span>v[,<span class="dv">1</span><span class="sc">:</span>numSV])</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>glm1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(y<span class="sc">~</span>., <span class="at">data=</span>dEmoji, <span class="at">family=</span>binomial)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(glm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = y ~ ., family = binomial, data = dEmoji)

Coefficients:
            Estimate Std. Error z value Pr(&gt;|z|)  
(Intercept)  18.3545    31.0428   0.591   0.5543  
u.1         189.1293   298.9776   0.633   0.5270  
u.2         -47.2114    31.2704  -1.510   0.1311  
u.3          -0.6238     4.7487  -0.131   0.8955  
u.4          14.2307    10.6325   1.338   0.1808  
u.5          -3.0133     8.5759  -0.351   0.7253  
u.6          -6.8907     5.3249  -1.294   0.1957  
u.7           2.5098     9.8337   0.255   0.7985  
u.8          21.6448    10.9007   1.986   0.0471 *
u.9         -11.0936     7.1880  -1.543   0.1227  
u.10          4.9520     7.5371   0.657   0.5112  
u.11          3.0832     5.5862   0.552   0.5810  
u.12        -15.1611     6.8649  -2.209   0.0272 *
u.13        -14.2660     7.2446  -1.969   0.0489 *
u.14         11.5790     5.6494   2.050   0.0404 *
u.15         -1.1332     3.6644  -0.309   0.7571  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 122.156  on 90  degrees of freedom
Residual deviance:  62.033  on 75  degrees of freedom
AIC: 94.033

Number of Fisher Scoring iterations: 8</code></pre>
</div>
</div>
<p>The logistic regression model output suggests that the weight put on eigenemoji 8, 12, 13, and 14 appear to be most important in deciding whether an emoji is positive or non-positive. Note the sign on the coefficients. A large positive value for eigenemojis 8 and 14 means that the emoji is <em>more</em> likely to be positive. Since the coefficients on <code>u.12</code> and <code>u.13</code> are negative, large positive values on eigenemojis 12 and 13 mean that they are <em>less</em> likely to be positive.</p>
<p>Here are those four most important eigenemojis for determining positive or non-positive.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">4</span>), <span class="at">mai=</span><span class="fu">c</span>(<span class="fl">0.1</span>,<span class="fl">0.1</span>,<span class="fl">0.5</span>,<span class="fl">0.1</span>))</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(j <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">12</span>,<span class="dv">13</span>,<span class="dv">14</span>))</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  svdEmoji<span class="sc">$</span>u[,j] <span class="sc">|&gt;</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">array</span>(<span class="at">dim=</span><span class="fu">c</span>(<span class="dv">256</span>,<span class="dv">256</span>,<span class="dv">1</span>,<span class="dv">3</span>)) <span class="sc">|&gt;</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  imager<span class="sc">::</span><span class="fu">as.cimg</span>() <span class="sc">|&gt;</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(<span class="at">axes=</span><span class="cn">FALSE</span>, </span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">main=</span><span class="fu">paste</span>(<span class="st">"Eigenemoji"</span>,j,<span class="st">" Beta:"</span>,</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">round</span>(<span class="fu">coef</span>(glm1)[j<span class="sc">+</span><span class="dv">1</span>],<span class="dv">1</span>))) <span class="co"># j+1 to account for Intercept</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-importantEigenEmojisPositive" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-importantEigenEmojisPositive-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L7-svd_files/figure-html/fig-importantEigenEmojisPositive-1.png" class="img-fluid figure-img" width="1400">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-importantEigenEmojisPositive-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18: The four most important eigenemojis for predicting positivity, including their logistic regression coefficient
</figcaption>
</figure>
</div>
</div>
</div>
<p>How well does the logistic regression do predicting positive emojis?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>dEmoji<span class="sc">$</span>yhat <span class="ot">&lt;-</span> <span class="fu">predict</span>(glm1, <span class="at">type=</span><span class="st">"response"</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(dEmoji, <span class="fu">table</span>(<span class="at">actual=</span>y, <span class="at">predicted=</span><span class="fu">as.numeric</span>(yhat<span class="sc">&gt;</span><span class="fl">0.5</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      predicted
actual  0  1
     0 47  8
     1  9 27</code></pre>
</div>
</div>
<p>It makes some mistakes. In 8 cases it predicts that the emoji is positive when it is actually not positive and in 9 cases it predicts that the emoji is not positive when it actually is positive. This misclassification rate is 0.19.</p>
<p>From our discussion of cross-validation you know that these rates “cheat”. We used the same data to estimate the model that we used to evaluate it. To fix that, let’s try leave-one-out cross-validation (LOOCV).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>dEmoji<span class="sc">$</span>yhatLOO <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(dEmoji))</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(dEmoji))</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  glm2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(y<span class="sc">~</span>., <span class="at">data=</span>dEmoji[<span class="sc">-</span>i,], <span class="at">family=</span>binomial)</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  dEmoji<span class="sc">$</span>yhatLOO[i] <span class="ot">&lt;-</span> <span class="fu">predict</span>(glm2, <span class="at">newdata=</span>dEmoji[i,], <span class="at">type=</span><span class="st">"response"</span>)</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred
Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(dEmoji, <span class="fu">table</span>(y,yhatLOO<span class="sc">&gt;</span><span class="fl">0.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   
y   FALSE TRUE
  0    40   15
  1     7   29</code></pre>
</div>
</div>
<p>Now we have a more proper calculation of the misclassification rate. The LOOCV misclassification rate is 0.24… a little worse than we previously estimated. This is typical since LOOCV performance measures give a more honest (less biased) estimate of performance.</p>
<p>As you build your machine learning toolbox, you will be able to use more flexible methods to get better predictive performance.</p>
</section>
<section id="summary" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Summary</h1>
<p>We have explored the principles and applications of Singular Value Decomposition (SVD), a fundamental linear algebra technique. By decomposing a matrix into three components (<span class="math inline">\(\mathbf{U}\)</span>, <span class="math inline">\(\Sigma\)</span>, <span class="math inline">\(\mathbf{V}\)</span>), SVD creates a compact representation of complicated data. We saw how SVD can compress images and convert images to a few numbers to allow us to build an image classifier.</p>
<ol type="1">
<li><strong>SVD</strong>:
<ul>
<li>The SVD of a matrix <span class="math inline">\(\mathbf{A}\)</span> is expressed as <span class="math inline">\(\mathbf{U} \Sigma \mathbf{V}'\)</span></li>
<li><span class="math inline">\(\mathbf{U}'\mathbf{U}=\mathbf{I}\)</span>, <span class="math inline">\(\mathbf{V}'\mathbf{V}=\mathbf{I}\)</span>, and <span class="math inline">\(\Sigma\)</span> is a diagonal matrix</li>
<li>SVD orders the singular values by size (importance), giving us a way to compress data by using only the largest singular values</li>
</ul></li>
<li><strong>Image Compression</strong>:
<ul>
<li>We compressed an image of “Stewart the Pandemic Parrot” to illustrate SVD-based compression</li>
<li>By retaining only the most significant singular values, the image is approximated with high accuracy while reducing its storage requirements</li>
</ul></li>
<li><strong>Emoji Classification</strong>:
<ul>
<li>We used SVD to compress a dataset of face emojis to classify them into “positive” and “non-positive” categories</li>
<li>The right singular vectors of the emoji matrices serve as features for classification</li>
<li>The example highlights SVD’s capability to extract meaningful features from complex datasets</li>
</ul></li>
<li><strong>Practical Applications</strong>:
<ul>
<li>Beyond images, SVD is widely used in text analysis (e.g., Latent Semantic Analysis), recommendation systems, and signal processing</li>
</ul></li>
</ol>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = true;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>