<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Greg Ridgeway">
<meta name="dcterms.date" content="2025-06-22">

<title>L9 Boosted propensity score estimation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="L09-propensity-score-estimation_files/libs/clipboard/clipboard.min.js"></script>
<script src="L09-propensity-score-estimation_files/libs/quarto-html/quarto.js"></script>
<script src="L09-propensity-score-estimation_files/libs/quarto-html/popper.min.js"></script>
<script src="L09-propensity-score-estimation_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="L09-propensity-score-estimation_files/libs/quarto-html/anchor.min.js"></script>
<link href="L09-propensity-score-estimation_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="L09-propensity-score-estimation_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="L09-propensity-score-estimation_files/libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="L09-propensity-score-estimation_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="L09-propensity-score-estimation_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="L09-propensity-score-estimation_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="L09-propensity-score-estimation_files/libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="L09-propensity-score-estimation_files/libs/kePrint-0.0.1/kePrint.js"></script>

<link href="L09-propensity-score-estimation_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction-to-estimating-treatment-effects-from-observational-studies" id="toc-introduction-to-estimating-treatment-effects-from-observational-studies" class="nav-link active" data-scroll-target="#introduction-to-estimating-treatment-effects-from-observational-studies"><span class="header-section-number">1</span> Introduction to estimating treatment effects from observational studies</a>
  <ul class="collapse">
  <li><a href="#example-florida-murderers" id="toc-example-florida-murderers" class="nav-link" data-scroll-target="#example-florida-murderers"><span class="header-section-number">1.1</span> Example: Florida murderers</a></li>
  <li><a href="#example-simulated-data-mathbfx-correlated-with-t" id="toc-example-simulated-data-mathbfx-correlated-with-t" class="nav-link" data-scroll-target="#example-simulated-data-mathbfx-correlated-with-t"><span class="header-section-number">1.2</span> Example: Simulated data (<span class="math inline">\(\mathbf{x}\)</span> correlated with <span class="math inline">\(t\)</span>)</a></li>
  <li><a href="#example-simulated-data-mathbfx-uncorrelated-with-t" id="toc-example-simulated-data-mathbfx-uncorrelated-with-t" class="nav-link" data-scroll-target="#example-simulated-data-mathbfx-uncorrelated-with-t"><span class="header-section-number">1.3</span> Example: Simulated data (<span class="math inline">\(\mathbf{x}\)</span> uncorrelated with <span class="math inline">\(t\)</span>)</a></li>
  </ul></li>
  <li><a href="#weights-to-uncorrelate-t-and-mathbfx" id="toc-weights-to-uncorrelate-t-and-mathbfx" class="nav-link" data-scroll-target="#weights-to-uncorrelate-t-and-mathbfx"><span class="header-section-number">2</span> Weights to uncorrelate <span class="math inline">\(t\)</span> and <span class="math inline">\(\mathbf{x}\)</span></a></li>
  <li><a href="#average-treatment-effect-ate-and-the-average-treatment-effect-on-the-treated-att" id="toc-average-treatment-effect-ate-and-the-average-treatment-effect-on-the-treated-att" class="nav-link" data-scroll-target="#average-treatment-effect-ate-and-the-average-treatment-effect-on-the-treated-att"><span class="header-section-number">3</span> Average Treatment Effect (ATE) and the Average Treatment Effect on the Treated (ATT)</a></li>
  <li><a href="#neyman-rubin-holland-causal-model" id="toc-neyman-rubin-holland-causal-model" class="nav-link" data-scroll-target="#neyman-rubin-holland-causal-model"><span class="header-section-number">4</span> Neyman-Rubin-Holland causal model</a></li>
  <li><a href="#estimation-of-att-with-propensity-scores" id="toc-estimation-of-att-with-propensity-scores" class="nav-link" data-scroll-target="#estimation-of-att-with-propensity-scores"><span class="header-section-number">5</span> Estimation of ATT with propensity scores</a></li>
  <li><a href="#example-florida-murderers-revisited" id="toc-example-florida-murderers-revisited" class="nav-link" data-scroll-target="#example-florida-murderers-revisited"><span class="header-section-number">6</span> Example: Florida murderers revisited</a></li>
  <li><a href="#boosted-propensity-score-estimation-with-nsduh" id="toc-boosted-propensity-score-estimation-with-nsduh" class="nav-link" data-scroll-target="#boosted-propensity-score-estimation-with-nsduh"><span class="header-section-number">7</span> Boosted propensity score estimation with NSDUH</a>
  <ul class="collapse">
  <li><a href="#propensity-score-estimation-with-logistic-regression" id="toc-propensity-score-estimation-with-logistic-regression" class="nav-link" data-scroll-target="#propensity-score-estimation-with-logistic-regression"><span class="header-section-number">7.1</span> Propensity score estimation with logistic regression</a></li>
  <li><a href="#outcome-analysis" id="toc-outcome-analysis" class="nav-link" data-scroll-target="#outcome-analysis"><span class="header-section-number">7.2</span> Outcome analysis</a></li>
  <li><a href="#propensity-score-estimation-with-boosting" id="toc-propensity-score-estimation-with-boosting" class="nav-link" data-scroll-target="#propensity-score-estimation-with-boosting"><span class="header-section-number">7.3</span> Propensity score estimation with boosting</a></li>
  <li><a href="#fastdr-to-estimate-propensity-score-estimates-and-doubly-robust-estimates" id="toc-fastdr-to-estimate-propensity-score-estimates-and-doubly-robust-estimates" class="nav-link" data-scroll-target="#fastdr-to-estimate-propensity-score-estimates-and-doubly-robust-estimates"><span class="header-section-number">7.4</span> <code>fastDR</code> to estimate propensity score estimates (and doubly robust estimates)</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">8</span> Summary</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="L09-propensity-score-estimation.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">L9 Boosted propensity score estimation</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Greg Ridgeway <a href="mailto:gridge@upenn.edu" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Pennsylvania
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 22, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<!-- In terminal -->
<!-- quarto render L09-propensity-score-estimation.qmd -->
<!-- quarto render L09-propensity-score-estimation.qmd --cache-refresh  -->
<!-- git commit L09-* -m "commit message" -->
<!-- git status -->
<!-- git push -->
<section id="introduction-to-estimating-treatment-effects-from-observational-studies" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction to estimating treatment effects from observational studies</h1>
<p>A common aim in social science is to estimate the causal effect of a treatment or exposure or condition on an outcome of interest.</p>
<ol type="1">
<li>Effect of a medical treatment on a disease outcome (e.g.&nbsp;survival, time to recovery)</li>
<li>Effect of race on a criminal justice outcome (e.g.&nbsp;arrest, sentence)</li>
<li>Effect of an educational program on reading or math scores</li>
</ol>
<p>Ideally, we would conduct a randomized controlled trial (RCT) in which we randomize a sample of individuals to either receive the treatment condition or to a control condition, which could be nothing, business as usual, or some placebo treatment. This is the gold standard approach in science. However, we have numerous questions that are difficult to assess with an RCT for reasons such as ethical considerations, cost, and rarity of outcomes. Particularly in the last several decades, we have access to large administrative datasets with numerous features on individuals and numerous outcomes. Even if we could technically conduct an RCT, it is worth exploring these datasets to assess which questions might have interesting findings.</p>
<p>“Observational studies” aim to draw causal conclusions from data in which the treatment or exposure was <em>not</em> under the control of the researcher. The most common form of “observational data” are data that were not collected for the purposes of analysis, but for some basic record keeping purpose, such as health insurance claims, arrest records, mortgage applications, or school attendance and grades.</p>
<p>The section will focus on one particular method of causal estimation in which machine learning plays a starring role, propensity score estimation.</p>
<section id="example-florida-murderers" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="example-florida-murderers"><span class="header-section-number">1.1</span> Example: Florida murderers</h2>
<p><span class="citation" data-cites="RadeletFloridaMurders">Radelet (<a href="#ref-RadeletFloridaMurders" role="doc-biblioref">1981</a>)</span> collected data on convicted in murderers in Florida between 1976-1977, including their race, their victim’s race, and whether or not they received the death penalty. Our primary interest here is to assess whether there is a racial disparity in the imposition of the death penalty.</p>
<p>Here are the Florida murderers data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>dFLmurder <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"W"</span>,<span class="st">"W"</span>,<span class="dv">1</span>),<span class="at">each=</span> <span class="dv">19</span>),<span class="at">ncol=</span><span class="dv">3</span>),</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>              <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"W"</span>,<span class="st">"W"</span>,<span class="dv">0</span>),<span class="at">each=</span><span class="dv">132</span>),<span class="at">ncol=</span><span class="dv">3</span>),</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>             <span class="co">#matrix(rep(c("W","B",1),each=  0),ncol=3),</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>              <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"W"</span>,<span class="st">"B"</span>,<span class="dv">0</span>),<span class="at">each=</span>  <span class="dv">9</span>),<span class="at">ncol=</span><span class="dv">3</span>),</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>              <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"B"</span>,<span class="st">"W"</span>,<span class="dv">1</span>),<span class="at">each=</span> <span class="dv">11</span>),<span class="at">ncol=</span><span class="dv">3</span>),</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>              <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"B"</span>,<span class="st">"W"</span>,<span class="dv">0</span>),<span class="at">each=</span> <span class="dv">52</span>),<span class="at">ncol=</span><span class="dv">3</span>),</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>              <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"B"</span>,<span class="st">"B"</span>,<span class="dv">1</span>),<span class="at">each=</span>  <span class="dv">6</span>),<span class="at">ncol=</span><span class="dv">3</span>),</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>              <span class="fu">matrix</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"B"</span>,<span class="st">"B"</span>,<span class="dv">0</span>),<span class="at">each=</span> <span class="dv">97</span>),<span class="at">ncol=</span><span class="dv">3</span>))</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>dFLmurder <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(dFLmurder) <span class="sc">|&gt;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">c</span>(<span class="st">"murderer"</span>,<span class="st">"victim"</span>,<span class="st">"death"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">death =</span> <span class="fu">as.numeric</span>(death))</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>dFLmurder <span class="sc">|&gt;</span> <span class="fu">group_by</span>(murderer,victim,death) <span class="sc">|&gt;</span> <span class="fu">count</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 4
# Groups:   murderer, victim, death [7]
  murderer victim death     n
  &lt;chr&gt;    &lt;chr&gt;  &lt;dbl&gt; &lt;int&gt;
1 B        B          0    97
2 B        B          1     6
3 B        W          0    52
4 B        W          1    11
5 W        B          0     9
6 W        W          0   132
7 W        W          1    19</code></pre>
</div>
</div>
<p>The simplest comparison would be to contrast the fraction of black murderers receiving the death penalty with the fraction of white murderers receiving the death penalty.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>dFLmurder <span class="sc">|&gt;</span> <span class="fu">group_by</span>(murderer) <span class="sc">|&gt;</span> <span class="fu">summarize</span>(<span class="at">deathPenalty=</span><span class="fu">mean</span>(death))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  murderer deathPenalty
  &lt;chr&gt;           &lt;dbl&gt;
1 B               0.102
2 W               0.119</code></pre>
</div>
</div>
<p>So, 10.2% of black murderers received the death compared with 11.9% of white murderers. It appears that white murderers are actually 1.6 percentage points <em>more</em> likely to receive the death penalty than black murderers.</p>
<p>By far the most common way social scientists have traditionally explored such questions is to use a regression model. With regression we can formally test whether the outcome differs by “treatment,” which in this case is the race of the murderer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compare death sentence for B vs. W murderers</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(death <span class="sc">~</span> murderer,<span class="at">data=</span>dFLmurder)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = death ~ murderer, data = dFLmurder)

Residuals:
    Min      1Q  Median      3Q     Max 
-0.1187 -0.1187 -0.1024 -0.1024  0.8976 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.10241    0.02439   4.198 3.48e-05 ***
murdererW    0.01634    0.03482   0.469    0.639    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.3143 on 324 degrees of freedom
Multiple R-squared:  0.0006793, Adjusted R-squared:  -0.002405 
F-statistic: 0.2202 on 1 and 324 DF,  p-value: 0.6392</code></pre>
</div>
</div>
<p>At first glance, the race of the murderer does not seem to matter. However, there is another variable in the dataset, the race of the victim. Let’s explore</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># do B &amp; W murderers differ by the victim's race?</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>dFLmurder <span class="sc">|&gt;</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(murderer) <span class="sc">|&gt;</span> </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">raceVictim =</span> <span class="fu">mean</span>(victim<span class="sc">==</span><span class="st">"B"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  murderer raceVictim
  &lt;chr&gt;         &lt;dbl&gt;
1 B            0.620 
2 W            0.0562</code></pre>
</div>
</div>
<p>It does seem that there are large differences in the race of the victims. The majority (62%) of black murderers had black victims. White murderers rarely had black victims (5.6%). Maybe this should not matter since we are really only interested in the race of the murderer, but let’s try “controlling” for the race of the victim. I put “controlling” in quotes because social scientists often say “I controlled for the race of the victim,” but what they really mean is that they put <code>+victim race</code> in a regression model, which is not the same and, as we will see, does not offer complete adjustment for the race of the victim.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># include race of victim in regression</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>lm3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(death <span class="sc">~</span> murderer<span class="sc">+</span>victim,<span class="at">data=</span>dFLmurder)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = death ~ murderer + victim, data = dFLmurder)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.17565 -0.12539 -0.12539 -0.05761  0.94239 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)   
(Intercept)  0.05761    0.02963   1.944  0.05276 . 
murdererW   -0.05026    0.04290  -1.172  0.24217   
victimW      0.11804    0.04516   2.614  0.00937 **
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.3115 on 323 degrees of freedom
Multiple R-squared:  0.02138,   Adjusted R-squared:  0.01532 
F-statistic: 3.529 on 2 and 323 DF,  p-value: 0.03047</code></pre>
</div>
</div>
<p>Now that we have included race of the victim, the sign on the race of the murderer has changed from positive to negative. Suddenly it seems that black murderers are <em>more</em> likely to get the death penalty by 5 percentage points. Why would include the race of the victim suddenly change our understanding of the relationship between the race of the murderer and receiving the death penalty?</p>
<p>Let’s examine some simple tables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>dFLmurder <span class="sc">|&gt;</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(murderer) <span class="sc">|&gt;</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">deathPenalty =</span> <span class="fu">mean</span>(death) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 2
  murderer deathPenalty
  &lt;chr&gt;           &lt;dbl&gt;
1 B               0.102
2 W               0.119</code></pre>
</div>
</div>
<p>Here we observe the 1.6 percentage point difference in the rate of death penalty imposition with white murderers being more likely to receive the death penalty.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>dFLmurder <span class="sc">|&gt;</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(murderer,victim) <span class="sc">|&gt;</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">deathPenalty =</span> <span class="fu">mean</span>(death) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'murderer'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
# Groups:   murderer [2]
  murderer victim deathPenalty
  &lt;chr&gt;    &lt;chr&gt;         &lt;dbl&gt;
1 B        B            0.0583
2 B        W            0.175 
3 W        B            0     
4 W        W            0.126 </code></pre>
</div>
</div>
<p>Once we break it down by race of the victim, we see that black murderers are more likely to receive the death penalty when their victim is black (by 5.8 percentage points) <em>and</em> when their victim is white (by 4.9 percentage points). Our conclusions have completely changed after we introduced the race of the victim.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Simpson’s Paradox
</div>
</div>
<div class="callout-body-container callout-body">
<p>In some datasets, after incorporating a third variable in the analysis, the conclusions can completely reverse. This is sometimes called Yule’s Paradox.</p>
</div>
</div>
<p>Why does this happen? In this example, the real driver of the death penalty seems to be the death of a white victim. When the victim is white, the murderer is much more likely to receive the death penalty. And who is most likely to have white victims?… white murderers. As a result, when we just compare black and white murderers it seems that white murderers are more likely to get the death penalty (which they are), but the reason we observe this is because they are the most likely to have a white victim.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Confounder
</div>
</div>
<div class="callout-body-container callout-body">
<p>A <strong>confounder</strong> is any variable that is associated with <em>both</em> the outcome of interest and the treatment. We are typically uninterested in the confounder’s association with the outcome, but instead just want to account for it in some way.</p>
</div>
</div>
<p>In the Florida murderers data, the race of the victim is associated with both the race of the murderer and the likelihood of receiving the death penalty. Our research question here focuses on the race of the murderer. We need to account for the race of the victim because we would like to think of two murderers of different races but with similar circumstances and determine who is more likely to receive the death penalty.</p>
<p>Race of the victim is only one confounder. Other mitigating and aggravating factors not recorded in these data could also explain the imposition of the death penalty, such as age of the victim, relationship to the victim, and intentionality of the homicide. Our thoughts about the racial differences in the death penalty could be reversed yet again with another confounder.</p>
</section>
<section id="example-simulated-data-mathbfx-correlated-with-t" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="example-simulated-data-mathbfx-correlated-with-t"><span class="header-section-number">1.2</span> Example: Simulated data (<span class="math inline">\(\mathbf{x}\)</span> correlated with <span class="math inline">\(t\)</span>)</h2>
<p>Now that we know confounders are important, let’s see whether a tool like regression is effective at accounting for potential confounders. Here I simulate some data where <span class="math display">\[
y_i = 0 + 0\times t_i + x_{1i} +x_{2i}+4x_{1i}x_{2i} + N(0,1)
\]</span> where <span class="math inline">\(t_i\)</span> is a 0/1 treatment assignment indicator and <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> are 0/1 confounders. I have simulated <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> so that they are more likely to be 1 when <span class="math inline">\(t=1\)</span>. Importantly, the outcome does not depend on <span class="math inline">\(t\)</span> since the coefficient in front of <span class="math inline">\(t\)</span> is 0, meaning that in this simulated example there is no treatment effect. Lastly, note that there is a rather large interaction effect. When <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> are both equal to 1, then the expected value of <span class="math inline">\(y\)</span> increases by 4.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">06182001</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">4</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>dataCor <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">treat=</span><span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="at">each=</span><span class="dv">100</span>)) <span class="sc">|&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">x1 =</span> <span class="fu">rbinom</span>(<span class="dv">200</span>, <span class="dv">1</span>, <span class="fl">0.3</span><span class="sc">*</span>treat <span class="sc">+</span> <span class="fl">0.9</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>treat)),</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">x2 =</span> <span class="fu">rbinom</span>(<span class="dv">200</span>, <span class="dv">1</span>, <span class="fl">0.3</span><span class="sc">*</span>treat <span class="sc">+</span> <span class="fl">0.9</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>treat)),</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>         <span class="at">y  =</span> <span class="fu">rnorm</span>(<span class="dv">200</span>, <span class="fu">cbind</span>(<span class="dv">1</span>,x1,x2,x1<span class="sc">*</span>x2)<span class="sc">%*%</span>beta, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The traditional social science approach is the regression model with additive terms for the treatment assignment, <span class="math inline">\(x_1\)</span>, and <span class="math inline">\(x_2\)</span>, expecting the <span class="math inline">\(+x_1+x_2\)</span> part to “control for” the confounders.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(y<span class="sc">~</span>treat<span class="sc">+</span>x1<span class="sc">+</span>x2, <span class="at">data=</span>dataCor))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ treat + x1 + x2, data = dataCor)

Residuals:
    Min      1Q  Median      3Q     Max 
-3.5435 -0.8583  0.1989  0.9039  2.9764 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.08564    0.34940   0.245  0.80663    
treat       -0.79105    0.29322  -2.698  0.00759 ** 
x1           2.65377    0.25975  10.217  &lt; 2e-16 ***
x2           2.95462    0.24213  12.202  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.39 on 196 degrees of freedom
Multiple R-squared:  0.7763,    Adjusted R-squared:  0.7729 
F-statistic: 226.8 on 3 and 196 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Yikes! This regression model found a significant treatment effect! But we simulated these data precisely so that there would be no treatment effect. Revisit how we simulated these data. <span class="math inline">\(treat\)</span> is not involved in determining the value of <span class="math inline">\(y\)</span>. <span class="math inline">\(y\)</span> only depends on <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span>, yet the regression model is telling us that $treat</p>
<p>In this case, the failure to include an important <span class="math inline">\(x_1x_2\)</span> interaction term caused us to make an incorrect inference about the effect of the treatment on the outcome. If we were clever enough to realize that there was an important interaction term, then we could simply add it in and correctly conclude that there was no treatment effect.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(y<span class="sc">~</span>treat<span class="sc">+</span>x1<span class="sc">+</span>x2<span class="sc">+</span>x1<span class="sc">:</span>x2, <span class="at">data=</span>dataCor))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ treat + x1 + x2 + x1:x2, data = dataCor)

Residuals:
     Min       1Q   Median       3Q      Max 
-2.88473 -0.60375 -0.01706  0.63581  2.33238 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.03804    0.24511   0.155  0.87681    
treat        0.16258    0.21628   0.752  0.45313    
x1           0.75209    0.22579   3.331  0.00104 ** 
x2           0.90262    0.22261   4.055 7.25e-05 ***
x1:x2        4.46055    0.31281  14.260  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.9751 on 195 degrees of freedom
Multiple R-squared:  0.8905,    Adjusted R-squared:  0.8883 
F-statistic: 396.5 on 4 and 195 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>This is the problem. In order to be sure to fully account for confounders, linear regression requires that we get the model structure right. This is very hard. There are a lot of methods for regression diagnostics, but they are complicated and become more complicated as the number of features increases. In datasets with dozens or hundreds of features, it becomes challenging to consider fully all of the potential interaction effects and non-linear effects. Neglecting an important one can drastically change your conclusions.</p>
<p>Before we move on to a different simulation, note that this dataset had a strong correlation between <span class="math inline">\(\mathbf{x}\)</span> and <span class="math inline">\(t\)</span> and, at the same time, <span class="math inline">\(t\)</span> was strongly associated with <span class="math inline">\(y\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(dataCor<span class="sc">$</span>x1, dataCor<span class="sc">$</span>treat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.6393057</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cor</span>(dataCor<span class="sc">$</span>x2, dataCor<span class="sc">$</span>treat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.5673086</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">aggregate</span>(y<span class="sc">~</span>treat, <span class="at">data=</span>dataCor, mean)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  treat        y
1     0 5.015015
2     1 0.897501</code></pre>
</div>
</div>
</section>
<section id="example-simulated-data-mathbfx-uncorrelated-with-t" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="example-simulated-data-mathbfx-uncorrelated-with-t"><span class="header-section-number">1.3</span> Example: Simulated data (<span class="math inline">\(\mathbf{x}\)</span> uncorrelated with <span class="math inline">\(t\)</span>)</h2>
<p>Here we will explore a similar simulation. However, this time <span class="math inline">\(\mathbf{x}\)</span> will be uncorrelated with <span class="math inline">\(t\)</span>. I added some correlation between <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span>, but both are completely unassociated with <span class="math inline">\(t\)</span>. As before, <span class="math inline">\(y\)</span> has no association with <span class="math inline">\(t\)</span>, but a particularly strong association with the <span class="math inline">\(x_1x_2\)</span> interaction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># independent</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">06182001</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>dataInd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">treat=</span><span class="fu">rep</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>,<span class="at">each=</span><span class="dv">100</span>))</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>dataInd<span class="sc">$</span>x1 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">200</span>, <span class="dv">1</span>, <span class="fl">0.6</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>dataInd<span class="sc">$</span>x2 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(<span class="dv">200</span>, <span class="dv">1</span>, <span class="fl">0.3</span><span class="sc">*</span>dataInd<span class="sc">$</span>x1 <span class="sc">+</span> <span class="fl">0.9</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>dataInd<span class="sc">$</span>x1))</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">4</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>dataInd<span class="sc">$</span>y  <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">200</span>, <span class="fu">with</span>(dataInd, <span class="fu">cbind</span>(<span class="dv">1</span>,x1,x2,x1<span class="sc">*</span>x2)<span class="sc">%*%</span>beta), <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This simulation is like what happens in a randomized trial. In randomized trials, the treatment assignment is unrelated to any of the <span class="math inline">\(x_j\)</span> by the researcher’s design.</p>
<p>If we use the simplest regression approach to check whether there is a treatment effect, we correctly conclude that there is no treatment effect. When <span class="math inline">\(t\)</span> was correlated with <span class="math inline">\(\mathbf{x}\)</span> in our previous simulation we found the opposite.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(y<span class="sc">~</span>treat, <span class="at">data=</span>dataInd))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ treat, data = dataInd)

Residuals:
    Min      1Q  Median      3Q     Max 
-3.6364 -1.5653 -0.7089  0.5261  6.1881 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)   1.9050     0.2295   8.301 1.59e-14 ***
treat         0.3425     0.3245   1.055    0.293    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 2.295 on 198 degrees of freedom
Multiple R-squared:  0.005593,  Adjusted R-squared:  0.0005707 
F-statistic: 1.114 on 1 and 198 DF,  p-value: 0.2926</code></pre>
</div>
</div>
<p>Let’s go ahead and adjust for <span class="math inline">\(\mathbf{x}\)</span> and see if it matters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(y<span class="sc">~</span>treat<span class="sc">+</span>x1<span class="sc">+</span>x2, <span class="at">data=</span>dataInd))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ treat + x1 + x2, data = dataInd)

Residuals:
    Min      1Q  Median      3Q     Max 
-3.3634 -0.8332 -0.0822  0.6639  4.3394 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -2.35221    0.23566  -9.981   &lt;2e-16 ***
treat       -0.07211    0.18023  -0.400     0.69    
x1           3.98421    0.21135  18.851   &lt;2e-16 ***
x2           3.80216    0.20841  18.243   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.262 on 196 degrees of freedom
Multiple R-squared:  0.7024,    Adjusted R-squared:  0.6978 
F-statistic: 154.2 on 3 and 196 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Still a null treatment effect, one that is even closer to 0 and with a smaller standard error.</p>
<p>Let’s add in the important missing interaction term.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(y<span class="sc">~</span>treat<span class="sc">+</span>x1<span class="sc">*</span>x2, <span class="at">data=</span>dataInd))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y ~ treat + x1 * x2, data = dataInd)

Residuals:
     Min       1Q   Median       3Q      Max 
-2.92707 -0.62959 -0.04675  0.69941  2.27152 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.16154    0.28336   0.570 0.569275    
treat        0.05738    0.13958   0.411 0.681445    
x1           1.03411    0.30269   3.416 0.000772 ***
x2           0.75288    0.30876   2.438 0.015648 *  
x1:x2        4.15820    0.35936  11.571  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.9741 on 195 degrees of freedom
Multiple R-squared:  0.8235,    Adjusted R-squared:  0.8199 
F-statistic: 227.5 on 4 and 195 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>We get a treatment effect estimate that is even smaller and a standard error that shows even more precision.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>When the treatment assignment (<span class="math inline">\(t\)</span>) is uncorrelated with the other features in the dataset (<span class="math inline">\(\mathbf{x}\)</span>), then the inclusion or exclusion of <span class="math inline">\(\mathbf{x}\)</span> has little effect on the overall conclusion. Including <span class="math inline">\(+x_1+x_2+\ldots\)</span> and correctly guessing its functional form can increase precision.</p>
</div>
</div>
<p>What if we could first eliminate the correlation between <span class="math inline">\(t\)</span> and <span class="math inline">\(\mathbf{x}\)</span> before fitting the regression model? In that case we would not have to worry so much if we include or fail to include certain features or transform them in a particular way.</p>
</section>
</section>
<section id="weights-to-uncorrelate-t-and-mathbfx" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Weights to uncorrelate <span class="math inline">\(t\)</span> and <span class="math inline">\(\mathbf{x}\)</span></h1>
<p>The distribution of <span class="math inline">\(x_1\)</span> is completely different among the treated cases compared to the control cases. Among those where <span class="math inline">\(t=0\)</span> we need a lot more <span class="math inline">\(x_1=0\)</span> and a lot fewer <span class="math inline">\(x_1=1\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> dataCor <span class="sc">|&gt;</span> <span class="fu">count</span>(x1, treat)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  x1 treat  n
1  0     0 10
2  0     1 73
3  1     0 90
4  1     1 27</code></pre>
</div>
</div>
<p>If each of the 10 control cases with <span class="math inline">\(x_1=0\)</span> were weighted by 73/10 and each of the 90 control cases with <span class="math inline">\(x_1=1\)</span> were weighted by 27/90, then the treatment and control groups would resemble each other. The 10 control cases with weights 73/10 would have total weight 73. The 90 control cases with weights 27/90 would have total weight 27.</p>
<p>Let’s add a new weight column to our data to reflect this idea and see what happens to the table and to the correlation between <span class="math inline">\(x_1\)</span> and <span class="math inline">\(t\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>dataCor <span class="ot">&lt;-</span> dataCor <span class="sc">|&gt;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">w=</span><span class="fu">case_when</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    treat<span class="sc">==</span><span class="dv">1</span> <span class="sc">~</span> <span class="dv">1</span>,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    treat<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> x1<span class="sc">==</span><span class="dv">0</span> <span class="sc">~</span> a<span class="sc">$</span>n[<span class="dv">2</span>]<span class="sc">/</span>a<span class="sc">$</span>n[<span class="dv">1</span>],</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    treat<span class="sc">==</span><span class="dv">0</span> <span class="sc">&amp;</span> x1<span class="sc">==</span><span class="dv">1</span> <span class="sc">~</span> a<span class="sc">$</span>n[<span class="dv">4</span>]<span class="sc">/</span>a<span class="sc">$</span>n[<span class="dv">3</span>]</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dataCor, <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   treat x1 x2          y   w
1      0  1  1  6.4177368 0.3
2      0  1  1  6.2164648 0.3
3      0  1  1  7.7950744 0.3
4      0  1  1  5.7997508 0.3
5      0  1  1  6.0748075 0.3
6      0  1  1  6.1228532 0.3
7      0  1  1  6.5539440 0.3
8      0  1  1  5.6138476 0.3
9      0  1  0  0.5535691 0.3
10     0  0  1 -0.1484591 7.3</code></pre>
</div>
</div>
<p>Now let’s check out the <em>weighted</em> total in the treatment and control groups</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>dataCor <span class="sc">|&gt;</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(x1, treat) <span class="sc">|&gt;</span> </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">sum</span>(w))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'x1'. You can override using the `.groups`
argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 3
# Groups:   x1 [2]
     x1 treat `sum(w)`
  &lt;int&gt; &lt;int&gt;    &lt;dbl&gt;
1     0     0       73
2     0     1       73
3     1     0       27
4     1     1       27</code></pre>
</div>
</div>
<p>In R, the best method for handling weighted data is through the <code>survey</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survey)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>sdesign <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>w, <span class="at">data=</span>dataCor)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>corXt <span class="ot">&lt;-</span> </span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">svyvar</span>(<span class="sc">~</span>treat<span class="sc">+</span>x1<span class="sc">+</span>x2, <span class="at">design=</span>sdesign) <span class="sc">|&gt;</span> </span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() <span class="sc">|&gt;</span> </span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cov2cor</span>() <span class="sc">|&gt;</span> </span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">zapsmall</span>()</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>corXt[,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          treat        x1         x2
treat  1.000000 0.0000000 -0.4485170
x1     0.000000 1.0000000  0.0091104
x2    -0.448517 0.0091104  1.0000000</code></pre>
</div>
</div>
<p>Now <span class="math inline">\(t\)</span> is completely uncorrelated with <span class="math inline">\(x_1\)</span>. The correlation matrix still shows very large correlation between <span class="math inline">\(t\)</span> and <span class="math inline">\(x_2\)</span>. Unfortunately, we are only part of the way there since we need to uncorrelate <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> at the same time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> dataCor <span class="sc">|&gt;</span> <span class="fu">count</span>(x1, x2, treat)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>a</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  x1 x2 treat  n
1  0  0     0  3
2  0  0     1 48
3  0  1     0  7
4  0  1     1 25
5  1  0     0 11
6  1  0     1 22
7  1  1     0 79
8  1  1     1  5</code></pre>
</div>
</div>
<p>Now it seems that we need 4 different weights for control cases to deal with all the <span class="math inline">\((x_1,x_2)\)</span> combinations. You can probably see that this is going to get exponentially more complex as we add more features, possibly discrete features with many categorical levels (like state or country) or continuous features (like age, SES, test scores).</p>
<p>Let’s rework the weight for control cases where <span class="math inline">\(\mathbf{x}'=[0\; 0]\)</span>. From the table above we can see that this weight should be 48/3.</p>
<p><span class="math display">\[
\begin{split}
w(x_1=0,x_2=0) &amp;= \frac{48}{3} \\
               &amp;= \frac{48}{3}\frac{\frac{1}{48+3}}{\frac{1}{48+3}} \\
               &amp;= \frac{\frac{48}{51}}{\frac{3}{51}} \\
               &amp;= \frac{\frac{48}{51}}{1-\frac{48}{51}} \\
               &amp;= \frac{P(t=1|x_1=0,x_2=0)}{1-P(t=1|x_1=0,x_2=0)}
\end{split}
\]</span></p>
<p>An equivalent way of thinking about the weight is the odds that an observation with features <span class="math inline">\(\mathbf{x}\)</span> is a member of the treatment group. Instead of building a table of all the combinations of <span class="math inline">\(\mathbf{x}\)</span> and <span class="math inline">\(t\)</span>, we can compute the odds of treatment assignment. Logistic regression is a perfect tool for computing the odds.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fit a fully interacted logistic regression model</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>logit1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(treat<span class="sc">~</span>x1<span class="sc">*</span>x2,<span class="at">data=</span>dataCor,<span class="at">family=</span>binomial)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co"># generate a table of all combinations of x1 and x2</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>wCheck <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x1=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="at">x2=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>) <span class="sc">|&gt;</span> </span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(x1,x2)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="co"># predict by default is on log odds scale, exp() to get odds scale</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>wCheck<span class="sc">$</span>w <span class="ot">&lt;-</span> <span class="fu">predict</span>(logit1, <span class="at">newdata=</span>wCheck) <span class="sc">|&gt;</span> </span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exp</span>() <span class="sc">|&gt;</span> </span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">zapsmall</span>()</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>wCheck</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  x1 x2         w
1  0  0 16.000000
2  0  1  3.571429
3  1  0  2.000000
4  1  1  0.063291</code></pre>
</div>
</div>
<p>With very little work we have produced all the weights we need. Check that the weights are the same as the weights you would have computed directly from the earlier table <code>a</code>. Let’s insert the appropriate weights into <code>dataCor</code> and check the correlations now.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># treatment cases all get weight 1</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>dataCor<span class="sc">$</span>w <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="co"># control cases get weights p/(1-p)</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>dataCor<span class="sc">$</span>w[dataCor<span class="sc">$</span>treat<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> </span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(logit1, <span class="at">newdata=</span><span class="fu">subset</span>(dataCor, treat<span class="sc">==</span><span class="dv">0</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exp</span>()</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co"># check that the total weights are equal now</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>dataCor <span class="sc">|&gt;</span> </span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(x1, x2, treat) <span class="sc">|&gt;</span> </span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="fu">sum</span>(w))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 4
# Groups:   x1, x2 [4]
     x1    x2 treat `sum(w)`
  &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;dbl&gt;
1     0     0     0    48.0 
2     0     0     1    48   
3     0     1     0    25.0 
4     0     1     1    25   
5     1     0     0    22.0 
6     1     0     1    22   
7     1     1     0     5.00
8     1     1     1     5   </code></pre>
</div>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># check correlation</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>sdesign <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>w, <span class="at">data=</span>dataCor)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>corXt <span class="ot">&lt;-</span> </span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">svyvar</span>(<span class="sc">~</span>treat<span class="sc">+</span>x1<span class="sc">+</span>x2, <span class="at">design=</span>sdesign) <span class="sc">|&gt;</span> </span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.matrix</span>() <span class="sc">|&gt;</span> </span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cov2cor</span>() <span class="sc">|&gt;</span> </span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">zapsmall</span>()</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>corXt[,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      treat         x1         x2
treat     1  0.0000000  0.0000000
x1        0  1.0000000 -0.1523733
x2        0 -0.1523733  1.0000000</code></pre>
</div>
</div>
<p>Now we have a dataset where the weighted dataset in which the weighted comparison cases collectively resemble the treatment cases. With this weighted dataset, we do not need to be concerned about <span class="math inline">\(x_1\)</span> or <span class="math inline">\(x_2\)</span> being confounders. They cannot be confounders because they are not associated with the treatment assignment.</p>
<p>What happens if we neglect to include <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> in our analysis?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">svyglm</span>(y<span class="sc">~</span>treat, <span class="at">design=</span>sdesign))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
svyglm(formula = y ~ treat, design = sdesign)

Survey design:
svydesign(ids = ~1, weights = ~w, data = dataCor)

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.82561    0.22964   3.595 0.000409 ***
treat        0.07189    0.28742   0.250 0.802741    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for gaussian family taken to be 2.576261)

Number of Fisher Scoring iterations: 2</code></pre>
</div>
</div>
<p>We correctly conclude that there is no treatment effect. Even though we simulated data in which <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> had strong effects on <span class="math inline">\(y\)</span>, neglecting their inclusion in our analysis did not really affect our findings. Including <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> may still be worthwhile to gain better precision.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">svyglm</span>(y<span class="sc">~</span>treat<span class="sc">+</span>x1<span class="sc">+</span>x2, <span class="at">design=</span>sdesign))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
svyglm(formula = y ~ treat + x1 + x2, design = sdesign)

Survey design:
svydesign(ids = ~1, weights = ~w, data = dataCor)

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -0.14895    0.25873  -0.576    0.565    
treat        0.07189    0.24829   0.290    0.772    
x1           1.76389    0.28375   6.216 3.00e-09 ***
x2           1.66102    0.31198   5.324 2.76e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for gaussian family taken to be 1.560209)

Number of Fisher Scoring iterations: 2</code></pre>
</div>
</div>
<p>Note that the treatment effect estimate is <em>identical</em>. Including <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> did nothing to change our treatment effect estimate. However, we did decrease the standard error of the treatment effect estimate. And if we consider all main effects and the interaction effect?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">svyglm</span>(y<span class="sc">~</span>treat<span class="sc">+</span>x1<span class="sc">*</span>x2, <span class="at">design=</span>sdesign))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
svyglm(formula = y ~ treat + x1 * x2, design = sdesign)

Survey design:
svydesign(ids = ~1, weights = ~w, data = dataCor)

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.17465    0.18067   0.967  0.33489    
treat        0.07189    0.18848   0.381  0.70329    
x1           0.73425    0.22057   3.329  0.00104 ** 
x2           0.71610    0.26768   2.675  0.00810 ** 
x1:x2        4.75751    0.40928  11.624  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for gaussian family taken to be 0.8175212)

Number of Fisher Scoring iterations: 2</code></pre>
</div>
</div>
<p>Still, the treatment effect estimate is unchanged, but the standard error is even smaller.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Analytical strategies that uncorrelate the treatment assignment (<span class="math inline">\(t\)</span>) from potential confounders (<span class="math inline">\(\mathbf{x}\)</span>) are robust to the inclusion or exclusion of <span class="math inline">\(\mathbf{x}\)</span> or any of their transformations.</p>
</div>
</div>
<p>A powerful method for uncorrelating the treatment assignment is to build observation weights based on <span class="math inline">\(P(t=1|\mathbf{x})\)</span>, which is known as the <strong>propensity score</strong>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Propensity score
</div>
</div>
<div class="callout-body-container callout-body">
<p>The propensity score is the probability of assignment to treatment conditional on the observation features, <span class="math inline">\(P(t=1|\mathbf{x})\)</span></p>
</div>
</div>
</section>
<section id="average-treatment-effect-ate-and-the-average-treatment-effect-on-the-treated-att" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Average Treatment Effect (ATE) and the Average Treatment Effect on the Treated (ATT)</h1>
<p>In the previous simulated example, we reweighted the control cases so that the distribution of their features aligned with the feature distribution of the treated cases. We accomplished by weighting cases as</p>
<p><span class="math display">\[
w_i = t_i + (1-t_i)\frac{P(t=1|\mathbf{x}_i)}{1-P(t=1|\mathbf{x}_i)}
\]</span></p>
<p>This assigns weight 1 to treatment cases and weights equal to the odds of treatment assignment to the comparison cases.</p>
<p>Because these weights make the control cases “look like” the treatment cases, the overall distribution of <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> match the distribution among the treatment cases. As a result, our treatment effect estimate describes what the treatment effect would be for the kinds of individuals that receive the treatment. If there is a particular value of <span class="math inline">\(\mathbf{x}\)</span> that made it impossible for someone to be in the treatment group, then <span class="math inline">\(P(t=1|\mathbf{x})=0\)</span> and any control case with that feature would receive weight 0 and be eliminated from the analysis.</p>
<p>Since these weights make the control cases resemble the treatment cases, our treatment effect estimate is called the <em>average treatment effect on the treated</em> (ATT). The ATE compares what actually happened to the treatment group to what would have happened had they not been treated. In the majority of social science inquiries, this is the primary quantity of interest.</p>
<ol type="1">
<li><p>When examining racial disparities in the justice system, we ask what would happen to members of a racial minority (“treated”) if their cases were handled the same way as the cases of white defendants. We reweight cases involving white defendants to collectively resemble cases involving minority defendants. That’s an ATT question.</p></li>
<li><p>When evaluating a reading program designed for schools in low income neighborhoods, we reweight students without access to the reading program to resemble the students in the schools in the low income neighborhoods with the reading program. …ATT.</p></li>
<li><p>When testing an urban health initiative, we would reweight residents in neighborhoods without the initiative to collective look like the residents in the neighborhood with the urban health initiative. Again… ATT.</p></li>
</ol>
<p>In each of these questions we are not interested in evaluating the treatment on the kinds of individuals or the kinds of places for which the treatment is not relevant. We focus our assessment on the kinds of cases, students, and places that concern us most for our investigation.</p>
<p>In some cases, we may be interested in the <em>average treatment effect on the population</em> (ATE). The ATE estimates the difference between what would happen if the entire population of interest was treated versus the entire population was left untreated. Several public health questions fall into this category, like vaccinations. The weights for estimating the ATE are <span class="math display">\[
w_i = t_i\frac{1}{P(t=1|\mathbf{x}_i)} + (1-t_i)\frac{1}{1-P(t=1|\mathbf{x}_i)}
\]</span> Treated cases receive a weight of <span class="math inline">\(\frac{1}{p}\)</span> while control cases receive a weight of <span class="math inline">\(\frac{1}{1-p}\)</span>. These weights reweight observations so that the distribution of <span class="math inline">\(\mathbf{x}\)</span> is the same for the treatment and control groups (just like with ATE) but that both of them also match the distribution of <span class="math inline">\(\mathbf{x}\)</span> for the population (rather than just the treatment group).</p>
</section>
<section id="neyman-rubin-holland-causal-model" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Neyman-Rubin-Holland causal model</h1>
<p>Often simply called the “Rubin causal model,” the foundational idea in its simplest form is that every unit of analysis has two values</p>
<ul>
<li><p><span class="math inline">\(Y_i(1)\)</span>, outcome of a case if assigned to treatment</p></li>
<li><p><span class="math inline">\(Y_i(0)\)</span>, outcome of a case if assigned to control</p></li>
</ul>
<p>We envision that every observation in our dataset has two <em>potential outcomes</em>, one that we would observe if they were assigned to the treatment and one that we would observe if they were assigned to the control. Then, ideally, we could compute the difference for each of them and average. This is the perfect way to estimate a causal effect.</p>
<table class="table">
<caption>Structure of the Rubin causal model</caption>
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th>Observation</th>
<th>Covariates</th>
<th>Treatment</th>
<th>Control</th>
<th>Unit causal effect</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td><span class="math inline">\(\mathbf{x}_1\)</span></td>
<td><span class="math inline">\(Y_1(1)\)</span></td>
<td><span class="math inline">\(Y_1(0)\)</span></td>
<td><span class="math inline">\(Y_1(1)-Y_1(0)\)</span></td>
</tr>
<tr class="even">
<td>2</td>
<td><span class="math inline">\(\mathbf{x}_2\)</span></td>
<td><span class="math inline">\(Y_2(1)\)</span></td>
<td><span class="math inline">\(Y_2(0)\)</span></td>
<td><span class="math inline">\(Y_2(1)-Y_2(0)\)</span></td>
</tr>
<tr class="odd">
<td>3</td>
<td><span class="math inline">\(\mathbf{x}_3\)</span></td>
<td><span class="math inline">\(Y_3(1)\)</span></td>
<td><span class="math inline">\(Y_3(0)\)</span></td>
<td><span class="math inline">\(Y_3(1)-Y_3(0)\)</span></td>
</tr>
<tr class="even">
<td><span class="math inline">\(\vdots\)</span></td>
<td><span class="math inline">\(\vdots\)</span></td>
<td><span class="math inline">\(\vdots\)</span></td>
<td><span class="math inline">\(\vdots\)</span></td>
<td><span class="math inline">\(\vdots\)</span></td>
</tr>
<tr class="odd">
<td>n</td>
<td><span class="math inline">\(\mathbf{x}_n\)</span></td>
<td><span class="math inline">\(Y_n(1)\)</span></td>
<td><span class="math inline">\(Y_n(0)\)</span></td>
<td><span class="math inline">\(Y_n(1)-Y_n(0)\)</span></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
<td><span class="math inline">\(ATE=\)</span></td>
<td><span class="math inline">\(\frac{1}{n} \sum Y_i(1)-Y_i(0)\)</span></td>
</tr>
</tbody>
</table>
<p>This idealized model, however, is faced with the fundamental problem of causal inference <span class="citation" data-cites="rubin1974">(<a href="#ref-rubin1974" role="doc-biblioref">Rubin 1974</a>)</span>.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Fundamental problem of causal inference
</div>
</div>
<div class="callout-body-container callout-body">
<p>For any observation we only get to observe <span class="math inline">\(Y_i(1)\)</span> <em>or</em> <span class="math inline">\(Y_i(0)\)</span>, but never both.</p>
</div>
</div>
<p>In spite of this challenge, under certain assumptions we can estimate some key quantities of interest.</p>
<p><span class="math display">\[
\begin{split}
ATT &amp;= \mathbb{E}(Y(1)-Y(0)|t=1) \\
&amp;= \mathbb{E}(Y(1)|t=1) - \mathbb{E}(Y(0)|t=1) \\
ATE &amp;= \mathbb{E}(Y(1) - Y(0)) \\
\end{split}
\]</span></p>
<p>Remember that for each observation we only observe one of the potential outcomes. So, we can easily estimate two quantities.</p>
<p><span class="math display">\[
\begin{split}
\mathbb{E}(Y(1)|t=1) &amp;\approx \frac{1}{n_1} \sum y_it_i \\
\mathbb{E}(Y(0)|t=0) &amp;\approx \frac{1}{n_0} \sum y_i(1-t_i)
\end{split}
\]</span></p>
<p>In general <span class="math display">\[
\mathbb{E}(Y(0)|t=0) \neq \mathbb{E}(Y(0)|t=1)
\]</span></p>
<p>But if cases are randomized to treatment then <span class="math display">\[
\mathbb{E}(Y(0)|t=0) = \mathbb{E}(Y(0)|t=1)
\]</span></p>
<p>The assumption of strong ignorability is essential for causal inference from observational data.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Strong ignorability
</div>
</div>
<div class="callout-body-container callout-body">
<p>Treatment assignment is <em>strongly ignorable</em> if the potential outcomes are independent of treatment assignment, conditional on <span class="math inline">\(\mathbf{x}\)</span>. <span class="math display">\[
(Y(1),Y(0)) \perp\!\!\!\!\perp t\, |\, \mathbf{x}
\]</span> or <span class="math display">\[
P(t=1|\mathbf{x},Y(1),Y(0)) = P(t=1|\mathbf{x})
\]</span></p>
</div>
</div>
<p>Strong ignorability holds if</p>
<ul>
<li><p><span class="math inline">\(\mathbf{x}\)</span> contains all of the confounders, or</p></li>
<li><p>treatment assignment depends on <span class="math inline">\(\mathbf{x}\)</span> alone, or</p></li>
<li><p>treatment is randomly assigned (special case of the previous)</p></li>
</ul>
<p>Regression models assume <span class="math display">\[
\begin{split}
\mathbb{E}(Y(t)) &amp;= \beta_0 + \alpha t + \beta_1x_1 + \ldots + \beta_dx_d \\
&amp;= \alpha t + \beta'\mathbf{x}
\end{split}
\]</span></p>
<p>In addition to strong ignorability, we have to assume that this is the correct relationship. As we saw previously, regression analysis is not kind to researchers when we neglect to include important terms.</p>
</section>
<section id="estimation-of-att-with-propensity-scores" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Estimation of ATT with propensity scores</h1>
<p>With a data set with <span class="math inline">\((y_i, t_i, \mathbf{x}_i)\)</span> for <span class="math inline">\(i=1,\ldots,n\)</span>, we want to estimate <span class="math display">\[
ATT = \mathbb{E}(Y(1)|t=1) - \mathbb{E}(Y(0)|t=1)
\]</span> The first term is actually easy to estimate. It asks us “among all the individuals who received the treatment, what would their average outcome be if they receive the treatment?” That we actually observed. <span class="math display">\[
\mathbb{\hat E}(Y(1)|t=1) = \frac{\sum t_iy_i}{\sum t_i}
\]</span></p>
<p>The harder one is the second term. It asks “for all the individuals who received treatment, what would their average outcome have been if they had not received the treatment?” This is a counterfactual expected value. We have no direct observations of this. But let’s work through some mathematics to see how we might estimate this.</p>
<p>Three items to recall from our probability discussion at the beginning of the course.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Expected value of a random variable
</div>
</div>
<div class="callout-body-container callout-body">
<p>If <span class="math inline">\(Y\)</span> is a random variable with probability distribution <span class="math inline">\(p(y)\)</span>, then expected value of <span class="math inline">\(Y\)</span> is <span class="math display">\[
\mathbb{E}(Y) = \int_{-\infty}^\infty y\; p(y)\, dy
\]</span></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Law of large numbers
</div>
</div>
<div class="callout-body-container callout-body">
<p>If <span class="math inline">\(y_1,\ldots,y_n\)</span> is a random sample from <span class="math inline">\(p(y)\)</span>, then as <span class="math inline">\(n\rightarrow\infty\)</span> <span class="math display">\[
\frac{1}{n} \sum_{i=1}^n g(y_i) \rightarrow \mathbb{E}(g(Y))
\]</span></p>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Bayes Theorem
</div>
</div>
<div class="callout-body-container callout-body">
<p><span class="math display">\[
p(y|t) = \frac{p(t|y)p(y)}{p(t)}
\]</span></p>
</div>
</div>
<p>We will use all of these properties to work through how to estimate <span class="math inline">\(\mathbb{E}(Y(0)|t=1)\)</span>. As you go through this line-by-line, ask yourself why we are able to move from one line to the next. Sometimes, it is simply algebra. Other steps involve the definition of expected value, Bayes Theorem, the assumption of strong ignorability, and the law of large numbers.</p>
<p><span class="math display">\[
\begin{split}
\mathbb{E}(Y(0)|t=1) &amp;= \iint y_0p(y_0,\mathbf{x}|t=1)\; d\mathbf{x}\,dy_0 \\
&amp;= \iint y_0 p(y_0,\mathbf{x}|t=1)
         \frac{p(y_0,\mathbf{x}|t=0)}{p(y_0,\mathbf{x}|t=0)}\; d\mathbf{x}\,dy_0 \\
&amp;= \iint y_0  
         \frac{p(y_0,\mathbf{x}|t=1)}{p(y_0,\mathbf{x}|t=0)}
         p(y_0,\mathbf{x}|t=0) \; d\mathbf{x}\,dy_0 \\
&amp;= \iint y_0  
         \frac{p(t=1|y_0,\mathbf{x})p(y_0,\mathbf{x})}
              {p(t=1)}
         \frac{p(t=0)}
              {p(t=0|y_0,\mathbf{x})p(y_0,\mathbf{x})}
         p(y_0,\mathbf{x}|t=0) \; d\mathbf{x}\,dy_0 \\
&amp;= \frac{p(t=0)}{p(t=1)}\iint y_0  
         \frac{p(t=1|y_0,\mathbf{x})}
              {p(t=0|y_0,\mathbf{x})}
         p(y_0,\mathbf{x}|t=0) \; d\mathbf{x}\,dy_0 \\
&amp;= \frac{p(t=0)}{p(t=1)}\iint y_0  
         \frac{p(t=1|\mathbf{x})}{p(t=0|\mathbf{x})}
         p(y_0,\mathbf{x}|t=0) \; d\mathbf{x}\,dy_0 \\
&amp;= \frac{p(t=0)}{p(t=1)}\iint y_0  
         \frac{p(t=1|\mathbf{x})}{1-p(t=1|\mathbf{x})}
         p(y_0,\mathbf{x}|t=0) \; d\mathbf{x}\,dy_0 \\
&amp;\approx \frac{p(t=0)}{p(t=1)}
    \frac{\sum_{i=1}^n (1-t_i)y_i  
         \frac{p(t=1|\mathbf{x}_i)}{1-p(t=1|\mathbf{x}_i)}}
        {\sum_{i=1}^n (1-t_i)} \\
&amp;\approx \frac{\sum_{i=1}^n (1-t_i)y_i  
         \frac{p(t=1|\mathbf{x}_i)}{1-p(t=1|\mathbf{x}_i)}}
        {\sum_{i=1}^n (1-t_i)\frac{p(t=1|\mathbf{x}_i)}{1-p(t=1|\mathbf{x}_i)}}
\end{split}
\]</span></p>
<p>The final step replacing <span class="math inline">\(\frac{p(t=1)}{1-p(t=1)}\sum (1-t_i)\)</span> with <span class="math inline">\(\sum (1-t_i)\frac{p(t=1|\mathbf{x}_i)}{1-p(t=1|\mathbf{x}_i)}\)</span> is not necessarily obvious, but here are the details. <span class="math display">\[
\begin{split}
1 &amp;= \iint p(y_0,\mathbf{x}|t=1)\; d\mathbf{x}\,dy_0 \\
&amp;= \iint p(y_0,\mathbf{x}|t=1)
         \frac{p(y_0,\mathbf{x}|t=0)}{p(y_0,\mathbf{x}|t=0)}\; d\mathbf{x}\,dy_0 \\
&amp;= \iint y_0  
         \frac{p(t=1|y_0,\mathbf{x})p(y_0,\mathbf{x})}
              {p(t=0|y_0,\mathbf{x})p(y_0,\mathbf{x})}
         \frac{p(t=0)}{p(t=1)}
         p(y_0,\mathbf{x}|t=0) \; d\mathbf{x}\,dy_0 \\
&amp;= \frac{p(t=0)}{p(t=1)}\iint y_0  
         \frac{p(t=1|\mathbf{x})}
              {p(t=0|\mathbf{x})}
         p(y_0,\mathbf{x}|t=0) \; d\mathbf{x}\,dy_0 \\
&amp;\approx \frac{p(t=0)}{p(t=1)}
    \frac{\sum_{i=1}^n (1-t_i)  
         \frac{p(t=1|\mathbf{x}_i)}{1-p(t=1|\mathbf{x}_i)}}
        {\sum_{i=1}^n (1-t_i)} \\
\frac{p(t=1)}{p(t=0)}\sum_{i=1}^n (1-t_i)&amp;\approx \sum_{i=1}^n (1-t_i)  
         \frac{p(t=1|\mathbf{x}_i)}{1-p(t=1|\mathbf{x}_i)}
\end{split}
\]</span></p>
<p>This formally shows that the approach we took earlier of weighting comparison cases with <span class="math inline">\(\frac{p}{1-p}\)</span> is a general approach for estimating ATT. The propensity score estimator for ATT is <span class="math display">\[
\begin{split}
\widehat{ATT} &amp;= \mathbb{\hat E}(Y(1)|t=1) - \mathbb{\hat E}(Y(0)|t=1) \\
  &amp;= \frac{\sum t_iy_i}{\sum t_i} - \frac{\sum (1-t_i)w_iy_i}
        {\sum (1-t_i)w_i}
\end{split}
\]</span> where <span class="math inline">\(w_i=\frac{p(t=1|\mathbf{x}_i)}{1-p(t=1|\mathbf{x}_i)}\)</span>.</p>
<p>The remaining problem is that we need to estimate the propensity score, <span class="math inline">\(p(t=1|\mathbf{x}_i)\)</span>. We will first work through an example with the Florida murders dataset and then we will work on a larger dataset.</p>
</section>
<section id="example-florida-murderers-revisited" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Example: Florida murderers revisited</h1>
<p>Let’s start with the easy part. <span class="math display">\[
\mathbb{\hat E}(Y(1)|t=1) = \frac{\sum t_iy_i}{\sum t_i}
\]</span></p>
<p>We have all of our “treated” cases and we get to observe the outcome for them when they are in the treatment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>dFLmurder <span class="sc">|&gt;</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(murderer<span class="sc">==</span><span class="st">"B"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">deathPenrate =</span> <span class="fu">mean</span>(death))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  deathPenrate
1    0.1024096</code></pre>
</div>
</div>
<p>To compute <span class="math inline">\(\mathbb{\hat E}(Y(0)|t=1)\)</span> we need to start with getting the propensity score weight for each murderer.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># predict treatment assignment from confounders</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>ps1 <span class="ot">&lt;-</span> <span class="fu">glm</span>((murderer<span class="sc">==</span><span class="st">"B"</span>)<span class="sc">~</span>victim, <span class="at">data=</span>dFLmurder, <span class="at">family=</span>binomial)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co"># set propensity score weights</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>dFLmurder<span class="sc">$</span>w <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>dFLmurder<span class="sc">$</span>w[dFLmurder<span class="sc">$</span>murderer<span class="sc">==</span><span class="st">"W"</span>] <span class="ot">&lt;-</span> </span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(ps1, <span class="at">newdata=</span><span class="fu">subset</span>(dFLmurder, murderer<span class="sc">==</span><span class="st">"W"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exp</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s check that black and white murderers now have the same distribution of victim race after weighting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>dFLmurder <span class="sc">|&gt;</span> </span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(murderer, victim) <span class="sc">|&gt;</span> </span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">totW=</span><span class="fu">sum</span>(w)) <span class="sc">|&gt;</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(murderer) <span class="sc">|&gt;</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pct =</span> totW<span class="sc">/</span><span class="fu">sum</span>(totW))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
# Groups:   murderer [2]
  murderer victim  totW   pct
  &lt;chr&gt;    &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 B        B      103   0.620
2 B        W       63   0.380
3 W        B      103.  0.620
4 W        W       63.0 0.380</code></pre>
</div>
</div>
<p>The distribution of victim race is now identical for black and white murderers. We are now set to compute <span class="math display">\[
\mathbb{\hat E}(Y(0)|t=1) = \frac{\sum (1-t_i)w_iy_i}{\sum (1-t_i)w_i}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>dFLmurder <span class="sc">|&gt;</span> </span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(murderer<span class="sc">==</span><span class="st">"W"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">deathPenRateW =</span> <span class="fu">weighted.mean</span>(death,w))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  deathPenRateW
1    0.04775393</code></pre>
</div>
</div>
<p>Putting this all into a regression framework allows us to compute ATT and its standard error more easily.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>sdesign <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>w, <span class="at">data=</span>dFLmurder)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>glm1 <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(death<span class="sc">~</span>murderer, <span class="at">design=</span>sdesign)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(glm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
svyglm(formula = death ~ murderer, design = sdesign)

Survey design:
svydesign(ids = ~1, weights = ~w, data = dFLmurder)

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.10241    0.02357   4.345 1.86e-05 ***
murdererW   -0.05466    0.02765  -1.977   0.0489 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for gaussian family taken to be 0.06890908)

Number of Fisher Scoring iterations: 2</code></pre>
</div>
</div>
<p>Our estimate of the ATT is -0.055, suggesting that the black murderer death penalty rate would be -5.5 percentage points smaller had they been treated as white murderers.</p>
<p>We can extract the ATT and a 95% confidence interval from the regression model as</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(glm1))</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>(a[<span class="st">"murdererW"</span>,<span class="st">"Estimate"</span>] <span class="sc">+</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)<span class="sc">*</span><span class="fl">1.96</span><span class="sc">*</span>a[<span class="st">"murdererW"</span>,<span class="st">"Std. Error"</span>]) <span class="sc">|&gt;</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.055 -0.109  0.000</code></pre>
</div>
</div>
<p>Could we get a more precise estimate for the ATT? Recall that in our simulation we tried adding some features to our model even when they were uncorrelated with the treatment assignment. When features are predictive of the outcome, then we can get more precision. Let’s give it a try.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>glm1 <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(death<span class="sc">~</span>murderer<span class="sc">+</span>victim, <span class="at">design=</span>sdesign)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(glm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
svyglm(formula = death ~ murderer + victim, design = sdesign)

Survey design:
svydesign(ids = ~1, weights = ~w, data = dFLmurder)

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.05645    0.02144   2.633  0.00887 ** 
murdererW   -0.05466    0.02533  -2.158  0.03168 *  
victimW      0.12109    0.02983   4.059 6.19e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for gaussian family taken to be 0.06544564)

Number of Fisher Scoring iterations: 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(glm1))</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>(a[<span class="st">"murdererW"</span>,<span class="st">"Estimate"</span>] <span class="sc">+</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)<span class="sc">*</span><span class="fl">1.96</span><span class="sc">*</span>a[<span class="st">"murdererW"</span>,<span class="st">"Std. Error"</span>]) <span class="sc">|&gt;</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">round</span>(<span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.055 -0.104 -0.005</code></pre>
</div>
</div>
<p>Including the victim’s race as a covariate has no effect on the ATT, but it does increase the precision of the ATT estimate.</p>
<p>It turns out that for least squares and Poisson regression, you can simply add covariates of interest to the regression model and the treatment effect estimate will simply be the coefficient in front of the treatment indicator. For other regression models, and specifically for logistic regression, extracting the ATT takes a little more work.</p>
</section>
<section id="boosted-propensity-score-estimation-with-nsduh" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Boosted propensity score estimation with NSDUH</h1>
<p>In this section we are going to use propensity score estimation with the National Survey on Drug Use and Health (NSDUH) to estimate the effect of past heroin use on current year arrest.</p>
<p>NSDUH provides national data on tobacco, alcohol, drug use, mental health, and related health topics. The data collection has been ongoing since 1971 and has been conducted every year since. The most recent data collection had 70,000 people interviewed. The <a href="https://www.samhsa.gov/">Substance Abuse and Mental Health Services Administration</a> (SAMHSA) with the Department of Health and Human Services manages the data collection. <a href="https://www.rti.org/">RTI International</a> has been collecting the data since 1988.</p>
<p>Previously we used logistic regression to estimate propensity scores. All the complaints I had about regression being insufficient for estimating causal effects, map over to using logistic regression for propensity scores. That is, failure to include important non-linear and interaction effects in the propensity score model will result in bad propensity score estimates and incorrect treatment effect estimates. For this reason, we will move beyond using logistic regression to estimate the propensity score and use boosting instead. The use of boosting for propensity score estimation was originally developed in <span class="citation" data-cites="McCaffreyRidgewayMorral:2004">McCaffrey, Ridgeway, and Morral (<a href="#ref-McCaffreyRidgewayMorral:2004" role="doc-biblioref">2004</a>)</span>.</p>
<p>Let’s start by loading up the NSDUH 2010 dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"data/nsduh.Rdata"</span>)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>nsduh <span class="ot">&lt;-</span> da32722<span class="fl">.0001</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’re going to study whether past heroin use is associated with arrest in the last year. We will set <code>heroin</code> to 1 if the respondent indicated that they had last used heroin more than 12 months ago (and none in the last year). I exclude respondents reporting heroin use in the current year. We will set <code>arrest</code> to 1 if the respondent reports being arrested in the prior 12 months. Responses that are <code>NA</code> indicate no heroin use or no arrests.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="co"># NOBOOKY measures number of times arrested and booked in previous 12 months</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="co"># NA = logical skip, blank, don't know... here assume no arrest</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 = 1 arrest</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 = 2 arrests</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 = 3 or more arrests</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>nsduh <span class="ot">&lt;-</span> nsduh <span class="sc">|&gt;</span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">arrest =</span> <span class="fu">as.numeric</span>(<span class="sc">!</span><span class="fu">is.na</span>(NOBOOKY2) <span class="sc">&amp;</span> NOBOOKY2<span class="sc">&gt;</span><span class="dv">0</span>)) <span class="sc">|&gt;</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="co"># HERREC measures last time used</span></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 1 = Within the past 30 days</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 2 = More than 30 days ago but within the past 12 mos</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 3 = More than 12 months ago</span></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 8 = Used at some point in the past 12 mos</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 9 = Used sometime in lifetime</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a><span class="co"># NA = never used, refused, blank</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(HERREC <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">8</span>))) <span class="sc">|&gt;</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">heroin =</span> <span class="fu">as.numeric</span>(<span class="sc">!</span><span class="fu">is.na</span>(HERREC) <span class="sc">&amp;</span> HERREC <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">9</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will consider a handful of potential confounders, race, sex, marital status, and age. Note that a marital status of <code>NA</code> is considered a legitimate value and those respondents are not dropped from the analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>nsduh <span class="ot">&lt;-</span> nsduh <span class="sc">|&gt;</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">NEWRACE2 =</span> <span class="fu">factor</span>(NEWRACE2, </span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">levels=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>, </span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>                           <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"W"</span>,<span class="st">"B"</span>,<span class="st">"NA.AN"</span>,<span class="st">"PI"</span>,<span class="st">"A"</span>,<span class="st">"Multi"</span>,<span class="st">"H"</span>)),</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">IRSEX =</span> <span class="fu">factor</span>(IRSEX, </span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">levels=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, </span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"M"</span>,<span class="st">"F"</span>)), </span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">IRMARIT =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(IRMARIT), <span class="dv">5</span>, IRMARIT),</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">IRMARIT =</span> <span class="fu">factor</span>(IRMARIT,</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>                          <span class="at">levels=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, </span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>                          <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"M"</span>,<span class="st">"W"</span>,<span class="st">"D"</span>,<span class="st">"N"</span>,<span class="st">"NA"</span>)),</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">CATAG7 =</span> <span class="fu">factor</span>(CATAG7, </span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>                          <span class="at">levels=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>,</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>                          <span class="at">labels=</span><span class="fu">c</span>(<span class="st">"12-13"</span>,<span class="st">"14-15"</span>,<span class="st">"16-17"</span>,<span class="st">"18-20"</span>,</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"21-25"</span>,<span class="st">"26-34"</span>,<span class="st">"35+"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>NSDUH has sampling weights <code>ANALWT_C</code>. These reweight the observations to collectively resemble the United States population. NSDUH oversamples people and oversamples in places where they believe they are more likely to get respondents answering yes to drug use. The weights are essential for adjusting the sample back to reflecting the population. To properly account for sampling weights in propensity score analysis, you should include them as weights in the propensity score model and multiply the resulting propensity score weights by the sampling weight in the outcome model <span class="citation" data-cites="Ridgeway2015PropensitySA">(<a href="#ref-Ridgeway2015PropensitySA" role="doc-biblioref">Ridgeway et al. 2015</a>)</span>. We will do this in the example below.</p>
<p>Let’s see how the treatment (prior heroin use) and control (no heroin use) groups differ on these features.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>nsduh <span class="sc">|&gt;</span> </span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin,NEWRACE2) <span class="sc">|&gt;</span> </span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">totW=</span><span class="fu">sum</span>(ANALWT_C)) <span class="sc">|&gt;</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin) <span class="sc">|&gt;</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totW=</span>totW<span class="sc">/</span><span class="fu">sum</span>(totW)) <span class="sc">|&gt;</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> heroin, <span class="at">values_from =</span> totW,</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_fill =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  NEWRACE2     `0`     `1`
  &lt;fct&gt;      &lt;dbl&gt;   &lt;dbl&gt;
1 W        0.670   0.710  
2 B        0.120   0.0957 
3 NA.AN    0.00473 0.0160 
4 PI       0.00298 0      
5 A        0.0458  0.00435
6 Multi    0.0123  0.0151 
7 H        0.145   0.159  </code></pre>
</div>
</div>
<p>Note that 71% of those reporting heroin use are white, while 67% of those reporting no heroin use are white. There are smaller differences for black and Hispanic respondents, but clear evidence that race is associated with heroin use.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>nsduh <span class="sc">|&gt;</span> </span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin,IRSEX) <span class="sc">|&gt;</span> </span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">totW=</span><span class="fu">sum</span>(ANALWT_C)) <span class="sc">|&gt;</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin) <span class="sc">|&gt;</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totW=</span>totW<span class="sc">/</span><span class="fu">sum</span>(totW)) <span class="sc">|&gt;</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> heroin, <span class="at">values_from =</span> totW)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  IRSEX   `0`   `1`
  &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt;
1 M     0.483 0.710
2 F     0.517 0.290</code></pre>
</div>
</div>
<p>Also, sex of the respondent appears to be associated with heroin use with men making up 71% of the heroin users compared with 48% of the non-heroin users.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>nsduh <span class="sc">|&gt;</span> </span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin,IRMARIT) <span class="sc">|&gt;</span> </span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">totW=</span><span class="fu">sum</span>(ANALWT_C)) <span class="sc">|&gt;</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin) <span class="sc">|&gt;</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totW=</span>totW<span class="sc">/</span><span class="fu">sum</span>(totW)) <span class="sc">|&gt;</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> heroin, <span class="at">values_from =</span> totW,</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_fill =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  IRMARIT    `0`      `1`
  &lt;fct&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 M       0.479  0.302   
2 W       0.0585 0.0220  
3 D       0.126  0.309   
4 N       0.289  0.367   
5 NA      0.0472 0.000816</code></pre>
</div>
</div>
<p>Marital status seems strongly associated with heroin use, with 30% of heroin users reported being married and 48% of non-heroin users reported being married. 68% of heroin users reported being divorced or never married compared to 42% for non-heroin users.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>nsduh <span class="sc">|&gt;</span> </span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin,CATAG7) <span class="sc">|&gt;</span> </span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">totW=</span><span class="fu">sum</span>(ANALWT_C)) <span class="sc">|&gt;</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin) <span class="sc">|&gt;</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totW=</span>totW<span class="sc">/</span><span class="fu">sum</span>(totW)) <span class="sc">|&gt;</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> heroin, <span class="at">values_from =</span> totW,</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_fill =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  CATAG7    `0`      `1`
  &lt;fct&gt;   &lt;dbl&gt;    &lt;dbl&gt;
1 12-13  0.0317 0.000119
2 14-15  0.0321 0.00257 
3 16-17  0.0335 0.00442 
4 18-20  0.0533 0.0311  
5 21-25  0.0808 0.0899  
6 26-34  0.143  0.210   
7 35+    0.626  0.662   </code></pre>
</div>
</div>
<p>Heroin use particularly afflicts 26-34 year olds disproportionately. All of these respondent features, race, sex, marital status, and age all are associated with prior heroin use. And all of them could plausibly be related to arrest as well. Therefore, it is essential that we properly account for their potential confounding effect.</p>
<section id="propensity-score-estimation-with-logistic-regression" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="propensity-score-estimation-with-logistic-regression"><span class="header-section-number">7.1</span> Propensity score estimation with logistic regression</h2>
<p>We begin by estimating the propensity score. Since NSDUH has sampling weights, we will first create a survey design object so that R knows that <code>ANALWT_C</code> is a special column in <code>nsduh</code> that needs to be incorporated into all analyses (weighted means, weighted variances, weighted regressions, etc.).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>sdesign <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>ANALWT_C, <span class="at">data=</span>nsduh)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>What would we conclude without any adjustment for demographic characteristics? Respondents with prior heroin use are 24 percentage points more likely to report being arrested in the last 12 months compared with non-heroin respondents.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">svyglm</span>(arrest<span class="sc">~</span>heroin, <span class="at">design=</span>sdesign) <span class="sc">|&gt;</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
svyglm(formula = arrest ~ heroin, design = sdesign)

Survey design:
svydesign(ids = ~1, weights = ~ANALWT_C, data = nsduh)

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 0.027004   0.001084  24.906  &lt; 2e-16 ***
heroin      0.089607   0.018818   4.762 1.92e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for gaussian family taken to be 0.02731343)

Number of Fisher Scoring iterations: 2</code></pre>
</div>
</div>
<p>Let’s pursue our propensity score strategy by fitting a standard logistic regression model predicting prior heroin use from the four demographic variables of interest. We use <code>quasibinomial</code> here just so that R does not complain about non-integer weights.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>ps1 <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(heroin <span class="sc">~</span> NEWRACE2<span class="sc">+</span>IRSEX<span class="sc">+</span>IRMARIT<span class="sc">+</span>CATAG7,</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">design=</span>sdesign,</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">family=</span>quasibinomial)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>All heroin users receive weight 1 and all non-heroin users receive weights <span class="math inline">\(\frac{p}{1-p}\)</span>, where <span class="math inline">\(p\)</span> is the propensity score.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>nsduh<span class="sc">$</span>w <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>nsduh<span class="sc">$</span>w[nsduh<span class="sc">$</span>heroin<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> nsduh <span class="sc">|&gt;</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(heroin<span class="sc">==</span><span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(ps1, <span class="at">newdata=</span>_) <span class="sc">|&gt;</span> </span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exp</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Even though we already used <code>ANALWT_C</code> in constructing the propensity scores, we need to multiply the propensity score weights by <code>ANALWT_C</code> to get the right answers. Gory details are in <span class="citation" data-cites="Ridgeway2015PropensitySA">Ridgeway et al. (<a href="#ref-Ridgeway2015PropensitySA" role="doc-biblioref">2015</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>nsduh <span class="ot">&lt;-</span> nsduh <span class="sc">|&gt;</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">w =</span> w<span class="sc">*</span>ANALWT_C)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If all of our prior reasoning is correct, then the propensity score weights should uncorrelate <code>heroin</code> and each of the demographic variables. Let’s check their weighted distributions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>nsduh <span class="sc">|&gt;</span> </span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin,NEWRACE2) <span class="sc">|&gt;</span> </span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">totW=</span><span class="fu">sum</span>(w)) <span class="sc">|&gt;</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin) <span class="sc">|&gt;</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totW=</span>totW<span class="sc">/</span><span class="fu">sum</span>(totW)) <span class="sc">|&gt;</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> heroin, <span class="at">values_from =</span> totW,</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_fill =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  NEWRACE2          `0`     `1`
  &lt;fct&gt;           &lt;dbl&gt;   &lt;dbl&gt;
1 W        0.711        0.710  
2 B        0.0960       0.0957 
3 NA.AN    0.0156       0.0160 
4 PI       0.0000000133 0      
5 A        0.00435      0.00435
6 Multi    0.0152       0.0151 
7 H        0.158        0.159  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>nsduh <span class="sc">|&gt;</span> </span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin,IRSEX) <span class="sc">|&gt;</span> </span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">totW=</span><span class="fu">sum</span>(w)) <span class="sc">|&gt;</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin) <span class="sc">|&gt;</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totW=</span>totW<span class="sc">/</span><span class="fu">sum</span>(totW)) <span class="sc">|&gt;</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> heroin, <span class="at">values_from =</span> totW)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  IRSEX   `0`   `1`
  &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt;
1 M     0.710 0.710
2 F     0.290 0.290</code></pre>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>nsduh <span class="sc">|&gt;</span> </span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin,IRMARIT) <span class="sc">|&gt;</span> </span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">totW=</span><span class="fu">sum</span>(w)) <span class="sc">|&gt;</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin) <span class="sc">|&gt;</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totW=</span>totW<span class="sc">/</span><span class="fu">sum</span>(totW)) <span class="sc">|&gt;</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> heroin, <span class="at">values_from =</span> totW)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  IRMARIT      `0`      `1`
  &lt;fct&gt;      &lt;dbl&gt;    &lt;dbl&gt;
1 M       0.302    0.302   
2 W       0.0221   0.0220  
3 D       0.308    0.309   
4 N       0.367    0.367   
5 NA      0.000816 0.000816</code></pre>
</div>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>nsduh <span class="sc">|&gt;</span> </span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin,CATAG7) <span class="sc">|&gt;</span> </span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">totW=</span><span class="fu">sum</span>(w)) <span class="sc">|&gt;</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin) <span class="sc">|&gt;</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totW=</span>totW<span class="sc">/</span><span class="fu">sum</span>(totW)) <span class="sc">|&gt;</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> heroin, <span class="at">values_from =</span> totW)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  CATAG7      `0`      `1`
  &lt;fct&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1 12-13  0.000119 0.000119
2 14-15  0.00258  0.00257 
3 16-17  0.00443  0.00442 
4 18-20  0.0313   0.0311  
5 21-25  0.0903   0.0899  
6 26-34  0.210    0.210   
7 35+    0.661    0.662   </code></pre>
</div>
</div>
<p>Everything appears to have worked out! The heroin and non-heroin groups now have the same race distribution, sex distribution, distribution of marital status, and age distribution. This is what we should see if heroin usage were randomly assigned to respondents. Now that <code>heroin</code> is uncorrelated with the demographic features, any regression analysis we conduct will be more robust to their inclusion or exclusion or use of interactions or lack of interaction effects.</p>
</section>
<section id="outcome-analysis" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="outcome-analysis"><span class="header-section-number">7.2</span> Outcome analysis</h2>
<p>The column <span class="math inline">\(w\)</span> contains our propensity score weights multiplied by the NSDUH sampling weights. We first set up a new survey design object with these new weights and proceed with a weighted regression model to compute the ATT.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>sdesign <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>w, <span class="at">data=</span>nsduh)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(arrest <span class="sc">~</span> heroin, <span class="at">design=</span>sdesign)</span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
svyglm(formula = arrest ~ heroin, design = sdesign)

Survey design:
svydesign(ids = ~1, weights = ~w, data = nsduh)

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 0.044266   0.002941  15.052  &lt; 2e-16 ***
heroin      0.072345   0.019016   3.804 0.000142 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for gaussian family taken to be 0.0726703)

Number of Fisher Scoring iterations: 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># report a 95% confidence interval</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(lm1))</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(a[<span class="st">"heroin"</span>,<span class="st">"Estimate"</span>] <span class="sc">+</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)<span class="sc">*</span><span class="fl">1.96</span><span class="sc">*</span>a[<span class="st">"heroin"</span>,<span class="st">"Std. Error"</span>], <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.072 0.035 0.110</code></pre>
</div>
</div>
<p>This is only a modest change from our original estimate that involved no adjustment for potential confounders. As before we can also include the demographic features in an effort to increase precision of our ATT.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(arrest <span class="sc">~</span> heroin<span class="sc">+</span>NEWRACE2<span class="sc">+</span>IRSEX<span class="sc">+</span>IRMARIT<span class="sc">+</span>CATAG7, </span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">design=</span>sdesign)</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">summary</span>(lm1) <span class="sc">|&gt;</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coef</span>()</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(a[<span class="st">"heroin"</span>,<span class="st">"Estimate"</span>] <span class="sc">+</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)<span class="sc">*</span><span class="fl">1.96</span><span class="sc">*</span>a[<span class="st">"heroin"</span>,<span class="st">"Std. Error"</span>], <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.072 0.036 0.108</code></pre>
</div>
</div>
<p>We get about a minimal reduction on the width of the confidence interval (a modest reduction) and no change in the actual estimate of ATT as expected.</p>
<p>All of this analysis is based on the assumption that we really uncorrelated those demographic features from prior heroin use. But did we? The balance tables shown previously just looked at the marginal distribution of the demographic features and not their interactions. Perhaps we are still doing the analysis wrong and neglecting to account for important interactions.</p>
<p>If we compare the treatment and comparison groups in terms of a race/sex interaction, we see some differences.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>nsduh <span class="sc">|&gt;</span> </span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin,NEWRACE2,IRSEX) <span class="sc">|&gt;</span> </span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">totW=</span><span class="fu">sum</span>(w)) <span class="sc">|&gt;</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin) <span class="sc">|&gt;</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totW=</span>totW<span class="sc">/</span><span class="fu">sum</span>(totW)) <span class="sc">|&gt;</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> heroin, <span class="at">values_from =</span> totW, </span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">0</span><span class="st">`</span><span class="ot">=</span><span class="fu">zapsmall</span>(<span class="st">`</span><span class="at">0</span><span class="st">`</span>)) <span class="sc">|&gt;</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="st">`</span><span class="at">1</span><span class="st">`</span><span class="sc">&gt;</span><span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 4
  NEWRACE2 IRSEX     `0`    `1`
  &lt;fct&gt;    &lt;fct&gt;   &lt;dbl&gt;  &lt;dbl&gt;
1 W        M     0.510   0.462 
2 W        F     0.202   0.248 
3 B        M     0.0635  0.0764
4 B        F     0.0325  0.0193
5 NA.AN    M     0.00940 0.0136
6 Multi    M     0.0102  0.0127
7 H        M     0.114   0.142 
8 H        F     0.0440  0.0173</code></pre>
</div>
</div>
<p>It is clear that we have not really matched well on this interaction. Whether the differences observed here matter all depends on how much the interaction affects the arrest outcome. Even if it does not matter in this example, we need to be concerned about those research questions with a large number of potential confounders. Also, all of the demographic features included here are categorical features. Non-linear effects may arise in the propensity score stage and failure to include them can result in incorrect estimates. We need a more robust method for estimating propensity scores.</p>
</section>
<section id="propensity-score-estimation-with-boosting" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="propensity-score-estimation-with-boosting"><span class="header-section-number">7.3</span> Propensity score estimation with boosting</h2>
<p>We will first walk through an example of obtaining boosted propensity scores directly using <code>gbmt()</code>. Then we will use the <code>fastDR</code> package that integrates a lot of these ideas.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gbm3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We start by estimating a propensity score model, predicting <code>heroin</code> from the demographic features. Some aspects of fitting the generalized boosted model change when estimating propensity scores. The primary change is our motivation. We are no longer interested in out-of-sample predictive performance. There is no future dataset that we are trying to predict. We are trying to understand for this specific dataset, how to explain which observations are in the treatment group and which ones are in the comparison group. The implication is that we do not do any cross-validation and we set <code>bag.fraction=1.0</code>. Both of these changes result in better <em>in-sample</em> predictive performance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240316</span>)</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>gbm1 <span class="ot">&lt;-</span> <span class="fu">gbmt</span>(heroin<span class="sc">~</span>NEWRACE2<span class="sc">+</span>IRSEX<span class="sc">+</span>IRMARIT<span class="sc">+</span>CATAG7,</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">data=</span>nsduh,</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">weights=</span>nsduh<span class="sc">$</span>ANALWT_C,</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>             <span class="at">distribution=</span><span class="fu">gbm_dist</span>(<span class="st">"Bernoulli"</span>),</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>             <span class="at">train_params =</span> <span class="fu">training_params</span>(</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>               <span class="at">num_trees =</span> <span class="dv">3000</span>,         <span class="co"># number of trees</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">shrinkage =</span> <span class="fl">0.003</span>,        <span class="co"># lambda</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>               <span class="at">bag_fraction =</span> <span class="fl">1.0</span>,</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>               <span class="at">num_train =</span> <span class="fu">nrow</span>(nsduh),</span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>               <span class="at">min_num_obs_in_node =</span> <span class="dv">10</span>,</span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>               <span class="at">interaction_depth =</span> <span class="dv">3</span>,    <span class="co"># number of splits</span></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>               <span class="at">num_features =</span> <span class="dv">4</span>),        <span class="co"># number of features</span></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">par_details=</span><span class="fu">gbmParallel</span>(<span class="at">num_threads=</span><span class="dv">8</span>),</span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>             <span class="at">is_verbose =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have a model fit, we need to decide the optimal number of iterations. It is somewhat of an open question about what it means to optimize the propensity score model. There is general consensus that the optimal propensity score model should produce propensity scores that makes the balance tables “look good.” There is also no consensus on what “looks good” means. I characterize the balance table based on the single largest difference in the table. The propensity score model is only as good as how well it balances the worst balanced feature. If there is one feature that does not align across the treatment and control groups, then there is a risk that we have not adequately accounted for its potential confounding effect.</p>
<p>For now we will use all 3,000 trees of our GBM model. We will consider optimizing the number of trees when we use <code>fastDR()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>nsduh<span class="sc">$</span>bw <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>nsduh<span class="sc">$</span>bw[nsduh<span class="sc">$</span>heroin<span class="sc">==</span><span class="dv">0</span>] <span class="ot">&lt;-</span> nsduh <span class="sc">|&gt;</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(heroin<span class="sc">==</span><span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(gbm1, <span class="at">newdata=</span>_, <span class="at">n.trees=</span><span class="dv">3000</span>) <span class="sc">|&gt;</span> </span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exp</span>()</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>nsduh <span class="ot">&lt;-</span> nsduh <span class="sc">|&gt;</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">bw =</span> bw<span class="sc">*</span>ANALWT_C)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s check the balance that we get from <code>gbmt()</code>. All of the marginal distributions look good. The largest difference in the treatment and control columns is about 0.006, less than a percentage point.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>nsduh <span class="sc">|&gt;</span> </span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin,NEWRACE2) <span class="sc">|&gt;</span> </span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">totW=</span><span class="fu">sum</span>(bw)) <span class="sc">|&gt;</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin) <span class="sc">|&gt;</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totW=</span>totW<span class="sc">/</span><span class="fu">sum</span>(totW)) <span class="sc">|&gt;</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> heroin, <span class="at">values_from =</span> totW,</span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_fill =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  NEWRACE2      `0`     `1`
  &lt;fct&gt;       &lt;dbl&gt;   &lt;dbl&gt;
1 W        0.716    0.710  
2 B        0.0936   0.0957 
3 NA.AN    0.0144   0.0160 
4 PI       0.000398 0      
5 A        0.00714  0.00435
6 Multi    0.0144   0.0151 
7 H        0.154    0.159  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>nsduh <span class="sc">|&gt;</span> </span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin,IRSEX) <span class="sc">|&gt;</span> </span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">totW=</span><span class="fu">sum</span>(bw)) <span class="sc">|&gt;</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin) <span class="sc">|&gt;</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totW=</span>totW<span class="sc">/</span><span class="fu">sum</span>(totW)) <span class="sc">|&gt;</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> heroin, <span class="at">values_from =</span> totW)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 3
  IRSEX   `0`   `1`
  &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt;
1 M     0.704 0.710
2 F     0.296 0.290</code></pre>
</div>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>nsduh <span class="sc">|&gt;</span> </span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin,IRMARIT) <span class="sc">|&gt;</span> </span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">totW=</span><span class="fu">sum</span>(bw)) <span class="sc">|&gt;</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin) <span class="sc">|&gt;</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totW=</span>totW<span class="sc">/</span><span class="fu">sum</span>(totW)) <span class="sc">|&gt;</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> heroin, <span class="at">values_from =</span> totW)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  IRMARIT     `0`      `1`
  &lt;fct&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1 M       0.305   0.302   
2 W       0.0231  0.0220  
3 D       0.307   0.309   
4 N       0.361   0.367   
5 NA      0.00396 0.000816</code></pre>
</div>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>nsduh <span class="sc">|&gt;</span> </span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin,CATAG7) <span class="sc">|&gt;</span> </span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">totW=</span><span class="fu">sum</span>(bw)) <span class="sc">|&gt;</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin) <span class="sc">|&gt;</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totW=</span>totW<span class="sc">/</span><span class="fu">sum</span>(totW)) <span class="sc">|&gt;</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> heroin, <span class="at">values_from =</span> totW)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  CATAG7     `0`      `1`
  &lt;fct&gt;    &lt;dbl&gt;    &lt;dbl&gt;
1 12-13  0.00266 0.000119
2 14-15  0.00367 0.00257 
3 16-17  0.00521 0.00442 
4 18-20  0.0321  0.0311  
5 21-25  0.0912  0.0899  
6 26-34  0.205   0.210   
7 35+    0.660   0.662   </code></pre>
</div>
</div>
<p>And let’s check that race/sex interaction. There are some modest differences with the largest about 0.025, much smaller than the 0.048 difference we got when we used logistic regression to estimate the propensity scores.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>nsduh <span class="sc">|&gt;</span> </span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin,NEWRACE2,IRSEX) <span class="sc">|&gt;</span> </span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">totW=</span><span class="fu">sum</span>(bw)) <span class="sc">|&gt;</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(heroin) <span class="sc">|&gt;</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">totW=</span>totW<span class="sc">/</span><span class="fu">sum</span>(totW)) <span class="sc">|&gt;</span></span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> heroin, <span class="at">values_from =</span> totW,</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">values_fill =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="st">`</span><span class="at">0</span><span class="st">`</span><span class="ot">=</span><span class="fu">zapsmall</span>(<span class="st">`</span><span class="at">0</span><span class="st">`</span>)) <span class="sc">|&gt;</span></span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="st">`</span><span class="at">1</span><span class="st">`</span><span class="sc">&gt;</span><span class="fl">0.01</span>) <span class="sc">|&gt;</span></span>
<span id="cb116-10"><a href="#cb116-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">n=</span><span class="cn">Inf</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 4
  NEWRACE2 IRSEX     `0`    `1`
  &lt;fct&gt;    &lt;fct&gt;   &lt;dbl&gt;  &lt;dbl&gt;
1 W        M     0.490   0.462 
2 W        F     0.227   0.248 
3 B        M     0.0656  0.0764
4 B        F     0.0280  0.0193
5 NA.AN    M     0.0122  0.0136
6 Multi    M     0.00995 0.0127
7 H        M     0.121   0.142 
8 H        F     0.0328  0.0173</code></pre>
</div>
</div>
<p>Finally, let’s complete our outcome analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>sdesign <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>bw, <span class="at">data=</span>nsduh)</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(arrest <span class="sc">~</span> heroin, <span class="at">design=</span>sdesign)</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
svyglm(formula = arrest ~ heroin, design = sdesign)

Survey design:
svydesign(ids = ~1, weights = ~bw, data = nsduh)

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 0.044079   0.004972   8.865  &lt; 2e-16 ***
heroin      0.072532   0.019434   3.732  0.00019 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for gaussian family taken to be 0.07262952)

Number of Fisher Scoring iterations: 2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(lm1))</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(a[<span class="st">"heroin"</span>,<span class="st">"Estimate"</span>] <span class="sc">+</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)<span class="sc">*</span><span class="fl">1.96</span><span class="sc">*</span>a[<span class="st">"heroin"</span>,<span class="st">"Std. Error"</span>], <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.073 0.034 0.111</code></pre>
</div>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(arrest <span class="sc">~</span> heroin<span class="sc">+</span>NEWRACE2<span class="sc">+</span>IRSEX<span class="sc">+</span>IRMARIT<span class="sc">+</span>CATAG7, </span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">design=</span>sdesign)</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(lm1))</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(a[<span class="st">"heroin"</span>,<span class="st">"Estimate"</span>] <span class="sc">+</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)<span class="sc">*</span><span class="fl">1.96</span><span class="sc">*</span>a[<span class="st">"heroin"</span>,<span class="st">"Std. Error"</span>], <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.072 0.035 0.109</code></pre>
</div>
</div>
</section>
<section id="fastdr-to-estimate-propensity-score-estimates-and-doubly-robust-estimates" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="fastdr-to-estimate-propensity-score-estimates-and-doubly-robust-estimates"><span class="header-section-number">7.4</span> <code>fastDR</code> to estimate propensity score estimates (and doubly robust estimates)</h2>
<p><code>fastDR</code> was originally developed as the Toolkit for Weighting and Analysis of Non-equivalent Groups (twang), a package I wrote some time ago. RAND continues to develop and maintain the <code>twang</code> package (<a href="https://www.rand.org/statistics/twang.html" class="uri">https://www.rand.org/statistics/twang.html</a>). <code>twang</code> has many options and those options come with some computational burdens. I stripped out the features that I use all the time, upgraded the boosting algorithm to <code>gbm3</code>, and added the ability to compute doubly robust estimates.</p>
<p>Start by installing <code>fastDR</code> from GitHub.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="co"># remotes::install_github("gregridgeway/fastDR")</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fastDR)</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kableExtra)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To estimate the propensity score estimates and the ATT, run the <code>fastDR()</code> function. You just need to separate out the outcome, treatment indicator, confounders, sampling weights, and an observation identifier.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>nsduh<span class="sc">$</span>w <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>ps2 <span class="ot">&lt;-</span> <span class="fu">fastDR</span>(<span class="fu">list</span>(<span class="at">y.form=</span><span class="sc">~</span>arrest, </span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">t.form=</span><span class="sc">~</span>heroin, </span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">x.form=</span><span class="sc">~</span>NEWRACE2<span class="sc">+</span>IRSEX<span class="sc">+</span>IRMARIT<span class="sc">+</span>CATAG7,</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">weights.form=</span><span class="sc">~</span>ANALWT_C,</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">key.form=</span><span class="sc">~</span>QUESTID2), </span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">data=</span>nsduh, </span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">shrinkage=</span><span class="fl">0.006</span>, </span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">n.trees=</span><span class="dv">3000</span>, </span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">y.dist=</span><span class="st">"quasibinomial"</span>, </span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>              <span class="at">verbose=</span><span class="cn">FALSE</span>,</span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>              <span class="at">par_details=</span><span class="fu">gbmParallel</span>(<span class="dv">12</span>,<span class="dv">1024</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Start by taking a peek at the resulting object and see what is stored in the <code>ps2</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(ps2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "ks"             "best.iter"      "balance.tab"    "w"             
 [5] "p"              "ks.un"          "balance.tab.un" "shrinkage"     
 [9] "n1"             "ESS"            "glm.un"         "glm.ps"        
[13] "glm.dr"         "z"              "effects"        "y.dist"        </code></pre>
</div>
</div>
<p>The <code>balance.tab.un</code> displays the unadjusted balance table. Here we can examine how the treatment and control groups differ before propensity score weighting. The column on the far right shows the Kolmogorov-Smirnov statistic, which for these variables is just the difference in their rates. It is a little more complicated for continuous variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a>ps2<span class="sc">$</span>balance.tab.un <span class="sc">|&gt;</span> </span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">digits =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_material_opt</span>(<span class="at">lightable_options=</span><span class="st">"striped"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-balanceUnweighted" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-balanceUnweighted-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;1: Balance table for unweighted observations
</figcaption>
<div aria-describedby="tbl-balanceUnweighted-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div>
<table class="lightable-material-dark lightable-striped do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">control</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">treatment</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">KS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">NEWRACE2:W</td>
<td style="text-align: right;">0.672</td>
<td style="text-align: right;">0.710</td>
<td style="text-align: right;">0.038</td>
</tr>
<tr class="even">
<td style="text-align: left;">NEWRACE2:B</td>
<td style="text-align: right;">0.120</td>
<td style="text-align: right;">0.096</td>
<td style="text-align: right;">-0.024</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NEWRACE2:NA.AN</td>
<td style="text-align: right;">0.005</td>
<td style="text-align: right;">0.016</td>
<td style="text-align: right;">0.011</td>
</tr>
<tr class="even">
<td style="text-align: left;">NEWRACE2:A</td>
<td style="text-align: right;">0.046</td>
<td style="text-align: right;">0.004</td>
<td style="text-align: right;">-0.042</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NEWRACE2:Multi</td>
<td style="text-align: right;">0.012</td>
<td style="text-align: right;">0.015</td>
<td style="text-align: right;">0.003</td>
</tr>
<tr class="even">
<td style="text-align: left;">NEWRACE2:H</td>
<td style="text-align: right;">0.145</td>
<td style="text-align: right;">0.159</td>
<td style="text-align: right;">0.014</td>
</tr>
<tr class="odd">
<td style="text-align: left;">IRSEX:M</td>
<td style="text-align: right;">0.483</td>
<td style="text-align: right;">0.710</td>
<td style="text-align: right;">0.227</td>
</tr>
<tr class="even">
<td style="text-align: left;">IRSEX:F</td>
<td style="text-align: right;">0.517</td>
<td style="text-align: right;">0.290</td>
<td style="text-align: right;">-0.227</td>
</tr>
<tr class="odd">
<td style="text-align: left;">IRMARIT:M</td>
<td style="text-align: right;">0.479</td>
<td style="text-align: right;">0.302</td>
<td style="text-align: right;">-0.178</td>
</tr>
<tr class="even">
<td style="text-align: left;">IRMARIT:W</td>
<td style="text-align: right;">0.059</td>
<td style="text-align: right;">0.022</td>
<td style="text-align: right;">-0.037</td>
</tr>
<tr class="odd">
<td style="text-align: left;">IRMARIT:D</td>
<td style="text-align: right;">0.126</td>
<td style="text-align: right;">0.309</td>
<td style="text-align: right;">0.183</td>
</tr>
<tr class="even">
<td style="text-align: left;">IRMARIT:N</td>
<td style="text-align: right;">0.288</td>
<td style="text-align: right;">0.367</td>
<td style="text-align: right;">0.078</td>
</tr>
<tr class="odd">
<td style="text-align: left;">IRMARIT:NA</td>
<td style="text-align: right;">0.047</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">-0.046</td>
</tr>
<tr class="even">
<td style="text-align: left;">CATAG7:12-13</td>
<td style="text-align: right;">0.032</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">-0.032</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CATAG7:14-15</td>
<td style="text-align: right;">0.032</td>
<td style="text-align: right;">0.003</td>
<td style="text-align: right;">-0.030</td>
</tr>
<tr class="even">
<td style="text-align: left;">CATAG7:16-17</td>
<td style="text-align: right;">0.034</td>
<td style="text-align: right;">0.004</td>
<td style="text-align: right;">-0.029</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CATAG7:18-20</td>
<td style="text-align: right;">0.053</td>
<td style="text-align: right;">0.031</td>
<td style="text-align: right;">-0.022</td>
</tr>
<tr class="even">
<td style="text-align: left;">CATAG7:21-25</td>
<td style="text-align: right;">0.081</td>
<td style="text-align: right;">0.090</td>
<td style="text-align: right;">0.009</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CATAG7:26-34</td>
<td style="text-align: right;">0.143</td>
<td style="text-align: right;">0.210</td>
<td style="text-align: right;">0.067</td>
</tr>
<tr class="even">
<td style="text-align: left;">CATAG7:35+</td>
<td style="text-align: right;">0.626</td>
<td style="text-align: right;">0.662</td>
<td style="text-align: right;">0.036</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</figure>
</div>
</div>
<p>The largest difference in the <a href="#tbl-balanceUnweighted" class="quarto-xref">Table&nbsp;1</a> is for <code>IRSEX</code> with a difference of 0.227. We can also extract that largest difference from the <code>ps2</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>ps2<span class="sc">$</span>ks.un</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.2267797</code></pre>
</div>
</div>
<p>What we are really interested in is the <code>balance.tab</code> object that contains the balance table after applying the propensity score weights.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>ps2<span class="sc">$</span>balance.tab <span class="sc">|&gt;</span> </span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">digits =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_material_opt</span>(<span class="at">lightable_options=</span><span class="st">"striped"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-balancePSweighted" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-balancePSweighted-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;2: Balance table for propensity score weighted observations
</figcaption>
<div aria-describedby="tbl-balancePSweighted-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div>
<table class="lightable-material-dark lightable-striped do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">control</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">treatment</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">KS</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">NEWRACE2:W</td>
<td style="text-align: right;">0.711</td>
<td style="text-align: right;">0.710</td>
<td style="text-align: right;">-0.002</td>
</tr>
<tr class="even">
<td style="text-align: left;">NEWRACE2:B</td>
<td style="text-align: right;">0.094</td>
<td style="text-align: right;">0.096</td>
<td style="text-align: right;">0.002</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NEWRACE2:NA.AN</td>
<td style="text-align: right;">0.016</td>
<td style="text-align: right;">0.016</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">NEWRACE2:A</td>
<td style="text-align: right;">0.006</td>
<td style="text-align: right;">0.004</td>
<td style="text-align: right;">-0.001</td>
</tr>
<tr class="odd">
<td style="text-align: left;">NEWRACE2:Multi</td>
<td style="text-align: right;">0.015</td>
<td style="text-align: right;">0.015</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">NEWRACE2:H</td>
<td style="text-align: right;">0.158</td>
<td style="text-align: right;">0.159</td>
<td style="text-align: right;">0.001</td>
</tr>
<tr class="odd">
<td style="text-align: left;">IRSEX:M</td>
<td style="text-align: right;">0.709</td>
<td style="text-align: right;">0.710</td>
<td style="text-align: right;">0.001</td>
</tr>
<tr class="even">
<td style="text-align: left;">IRSEX:F</td>
<td style="text-align: right;">0.291</td>
<td style="text-align: right;">0.290</td>
<td style="text-align: right;">-0.001</td>
</tr>
<tr class="odd">
<td style="text-align: left;">IRMARIT:M</td>
<td style="text-align: right;">0.303</td>
<td style="text-align: right;">0.302</td>
<td style="text-align: right;">-0.001</td>
</tr>
<tr class="even">
<td style="text-align: left;">IRMARIT:W</td>
<td style="text-align: right;">0.022</td>
<td style="text-align: right;">0.022</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">IRMARIT:D</td>
<td style="text-align: right;">0.308</td>
<td style="text-align: right;">0.309</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">IRMARIT:N</td>
<td style="text-align: right;">0.364</td>
<td style="text-align: right;">0.367</td>
<td style="text-align: right;">0.002</td>
</tr>
<tr class="odd">
<td style="text-align: left;">IRMARIT:NA</td>
<td style="text-align: right;">0.002</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">-0.001</td>
</tr>
<tr class="even">
<td style="text-align: left;">CATAG7:12-13</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">-0.001</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CATAG7:14-15</td>
<td style="text-align: right;">0.003</td>
<td style="text-align: right;">0.003</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">CATAG7:16-17</td>
<td style="text-align: right;">0.005</td>
<td style="text-align: right;">0.004</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CATAG7:18-20</td>
<td style="text-align: right;">0.031</td>
<td style="text-align: right;">0.031</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="even">
<td style="text-align: left;">CATAG7:21-25</td>
<td style="text-align: right;">0.090</td>
<td style="text-align: right;">0.090</td>
<td style="text-align: right;">0.000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CATAG7:26-34</td>
<td style="text-align: right;">0.208</td>
<td style="text-align: right;">0.210</td>
<td style="text-align: right;">0.002</td>
</tr>
<tr class="even">
<td style="text-align: left;">CATAG7:35+</td>
<td style="text-align: right;">0.662</td>
<td style="text-align: right;">0.662</td>
<td style="text-align: right;">0.000</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</figure>
</div>
</div>
<p>Note that after weighting, the treatment and control groups look very similar. The largest difference in the table above is 0.002. You can access this largest KS statistic from the <code>ps2</code> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>ps2<span class="sc">$</span>ks</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.002178828</code></pre>
</div>
</div>
<p>We can also extract the number of treatment cases and the effective sample size of the weighted control cases.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>ps2<span class="sc">$</span>n1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 599</code></pre>
</div>
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>ps2<span class="sc">$</span>ESS</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4223.858</code></pre>
</div>
</div>
<p>The effective sample size (ESS) is the equivalent number of independent, unweighted observations that would give you the same precision as the observed, weighted data. If <span class="math inline">\(\mathrm{Var}(y)=\sigma^2\)</span>, then we are looking for <span class="math inline">\(ESS\)</span> that solves <span class="math display">\[
\begin{split}
\frac{\sigma^2}{ESS} &amp;= \mathrm{Var}\left(\frac{\sum w_iy_i}{\sum w_i}\right) \\
   &amp;= \frac{\mathrm{Var}(\sum w_iy_i)}{(\sum w_i)^2} \\
   &amp;= \frac{\sum w_i^2\mathrm{Var}(y_i)}{(\sum w_i)^2} \\
   &amp;= \sigma^2\frac{\sum w_i^2}{(\sum w_i)^2} \\
   &amp;= \frac{\sigma^2}{\frac{(\sum w_i)^2}{\sum w_i^2}} \\
ESS &amp;= \frac{(\sum w_i)^2}{\sum w_i^2}
\end{split}
\]</span></p>
<p>Since the cases all have weights, many of which could be near 0, the ESS gives a useful way of gauging the amount of information in the data for the estimate of <span class="math inline">\(\mathbb{\hat E}(Y(0)|t=1)\)</span>.</p>
<p>Lastly, we can extract the estimates of ATT.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>ps2<span class="sc">$</span>effects<span class="sc">$</span>arrest <span class="sc">|&gt;</span> </span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>(<span class="at">digits =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_material_opt</span>(<span class="at">lightable_options=</span><span class="st">"striped"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tbl-ATTestimate" class="cell quarto-float anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-ATTestimate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;3: Results table showing unweighted, propensity score weighted, and DR estimates
</figcaption>
<div aria-describedby="tbl-ATTestimate-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div>
<table class="lightable-material-dark lightable-striped do-not-create-environment cell table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">E.y1</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">E.y0</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">se.y1</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">se.y0</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">TE</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">se.TE</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">un</td>
<td style="text-align: right;">0.117</td>
<td style="text-align: right;">0.027</td>
<td style="text-align: right;">0.019</td>
<td style="text-align: right;">0.001</td>
<td style="text-align: right;">0.090</td>
<td style="text-align: right;">0.019</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">ps</td>
<td style="text-align: right;">0.117</td>
<td style="text-align: right;">0.045</td>
<td style="text-align: right;">0.019</td>
<td style="text-align: right;">0.006</td>
<td style="text-align: right;">0.072</td>
<td style="text-align: right;">0.020</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">dr</td>
<td style="text-align: right;">0.117</td>
<td style="text-align: right;">0.056</td>
<td style="text-align: right;">0.019</td>
<td style="text-align: right;">0.006</td>
<td style="text-align: right;">0.061</td>
<td style="text-align: right;">0.023</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>


</div>
</div>
</div>
</figure>
</div>
</div>
<p>The first row of <a href="#tbl-ATTestimate" class="quarto-xref">Table&nbsp;3</a> shows the unadjusted analysis. The second row shows a propensity score analysis. The third row shows a doubly robust analysis, one that includes the features in the outcome regression model. The first column is the arrest rate for the heroin group. This remains unchanged regardless of the estimator. The second column is the arrest rate for the comparison group that is either unadjusted, propensity score weighted, or a doubly robust estimate. The next two columns show their standard errors. <code>TE</code> and <code>se.TE</code> show the treatment effect (ATT) and the standard error of the treatment effect. The final column shows the p-value.</p>
<p>Heroin users had an arrest rate of 11.7%. Based on the doubly robust analysis, respondents who were similar to the heroin users (based on age, race, sex, and marital status) had an arrest rate of 5.6%. The ATT is the difference in these two percentages, 6.1 percentage points. We can get a 95% confidence interval by taking the <code>TE</code> and adding/subtracting 1.96 times the <code>se.TE</code>, which gives us</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a>att <span class="ot">&lt;-</span> ps2<span class="sc">$</span>effects<span class="sc">$</span>arrest[<span class="st">"dr"</span>,<span class="st">"TE"</span>]</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>se  <span class="ot">&lt;-</span> ps2<span class="sc">$</span>effects<span class="sc">$</span>arrest[<span class="st">"dr"</span>,<span class="st">"se.TE"</span>]</span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ATT estimate and 95% confidence interval</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a><span class="dv">100</span><span class="sc">*</span><span class="fu">round</span>(att <span class="sc">+</span> <span class="fl">1.96</span><span class="sc">*</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>)<span class="sc">*</span>se, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  6.1  1.6 10.6</code></pre>
</div>
</div>
<p>These are powerful tools, but can only give results that are as good as the data. If the data have limited features, then you will be limited in how much confounding you can address. The most common failure of propensity score methods is the inability to measure important confounders in the first place. Propensity score methods only produce causal effects if strong ignorability holds. To get there often means very comprehensive data collection on the units of analysis and accounting for all of them in the propensity score model.</p>
</section>
</section>
<section id="summary" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> Summary</h1>
<p>We covered a few ways of estimating treatment effects in observational studies, noting the fundamental problem of causal inference, inferring what would have happened in the absence of treatment. We covered propensity score estimation, weighting techniques to adjust for confounders, and the use of machine learning for propensity score estimation.</p>
<ol type="1">
<li><strong>Causal Estimation</strong>:
<ul>
<li>Simpson’s Paradox: after incorporating a third variable in an analysis, the conclusions can reverse</li>
<li>Observational studies aim to infer causal relationships where randomization is impractical</li>
<li>Key challenges include addressing confounding variables</li>
<li>Neyman-Rubin Causal Model: Framework underpinning causal inference methods, formalizing the challenge of unobserved counterfactuals</li>
</ul></li>
<li><strong>Propensity Score Methods</strong>:
<ul>
<li>Probability of treatment assignment given observed covariates</li>
<li>Balances covariate distributions between treatment and control groups to estimate causal effects</li>
<li>Use boosting to improve estimates compared to logistic regression</li>
</ul></li>
<li><strong>Practical Applications</strong>:
<ul>
<li>Florida murderers analysis showed the importance of addressing race of victims, an important confounding variable</li>
<li>NSDUH to study the effect of prior heroin use on future arrest
<ul>
<li>demonstrating propensity score with sampling weights</li>
</ul></li>
</ul></li>
</ol>

</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-McCaffreyRidgewayMorral:2004" class="csl-entry" role="listitem">
McCaffrey, D. M., G. Ridgeway, and A. R. Morral. 2004. <span>“Propensity Score Estimation with Boosted Regression for Evaluating Causal Effects in Observational Studies.”</span> <em>Psychological Methods</em> 9 (4): 403–25.
</div>
<div id="ref-RadeletFloridaMurders" class="csl-entry" role="listitem">
Radelet, Michael L. 1981. <span>“Racial Characteristics and the Imposition of the Death Penalty.”</span> <em>American Sociological Review</em> 46 (6): 918–27. <a href="http://www.jstor.org/stable/2095088">http://www.jstor.org/stable/2095088</a>.
</div>
<div id="ref-Ridgeway2015PropensitySA" class="csl-entry" role="listitem">
Ridgeway, Greg, Stephanie A Kovalchik, Beth Ann Griffin, and Mohammed U. Kabeto. 2015. <span>“Propensity Score Analysis with Survey Weighted Data.”</span> <em>Journal of Causal Inference</em> 3: 237–49. <a href="https://api.semanticscholar.org/CorpusID:3490612">https://api.semanticscholar.org/CorpusID:3490612</a>.
</div>
<div id="ref-rubin1974" class="csl-entry" role="listitem">
Rubin, Donald B. 1974. <span>“Estimating Causal Effects of Treatments in Randomized and Nonrandomized Studies.”</span> <em>Journal of Educational Psychology</em> 66 (5): 688.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = true;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>