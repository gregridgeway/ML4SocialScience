<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Greg Ridgeway">
<meta name="dcterms.date" content="2025-02-16">

<title>Differential calculus review</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="L4-calculus-review_files/libs/clipboard/clipboard.min.js"></script>
<script src="L4-calculus-review_files/libs/quarto-html/quarto.js"></script>
<script src="L4-calculus-review_files/libs/quarto-html/popper.min.js"></script>
<script src="L4-calculus-review_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="L4-calculus-review_files/libs/quarto-html/anchor.min.js"></script>
<link href="L4-calculus-review_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="L4-calculus-review_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="L4-calculus-review_files/libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="L4-calculus-review_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="L4-calculus-review_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="L4-calculus-review_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="L4-calculus-review_files/libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#properties-of-derivatives" id="toc-properties-of-derivatives" class="nav-link active" data-scroll-target="#properties-of-derivatives"><span class="header-section-number">1</span> Properties of derivatives</a>
  <ul class="collapse">
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">1.1</span> Exercises</a></li>
  </ul></li>
  <li><a href="#optimization" id="toc-optimization" class="nav-link" data-scroll-target="#optimization"><span class="header-section-number">2</span> Optimization</a>
  <ul class="collapse">
  <li><a href="#quadratic" id="toc-quadratic" class="nav-link" data-scroll-target="#quadratic"><span class="header-section-number">2.1</span> Quadratic</a></li>
  <li><a href="#minimize-squared-differences-with-three-values" id="toc-minimize-squared-differences-with-three-values" class="nav-link" data-scroll-target="#minimize-squared-differences-with-three-values"><span class="header-section-number">2.2</span> Minimize squared differences with three values</a></li>
  <li><a href="#minimize-squared-differences-with-n-values" id="toc-minimize-squared-differences-with-n-values" class="nav-link" data-scroll-target="#minimize-squared-differences-with-n-values"><span class="header-section-number">2.3</span> Minimize squared differences with <span class="math inline">\(n\)</span> values</a></li>
  <li><a href="#estimating-a-probability" id="toc-estimating-a-probability" class="nav-link" data-scroll-target="#estimating-a-probability"><span class="header-section-number">2.4</span> Estimating a probability</a></li>
  <li><a href="#exercises-1" id="toc-exercises-1" class="nav-link" data-scroll-target="#exercises-1"><span class="header-section-number">2.5</span> Exercises</a></li>
  </ul></li>
  <li><a href="#gradient-descent" id="toc-gradient-descent" class="nav-link" data-scroll-target="#gradient-descent"><span class="header-section-number">3</span> Gradient descent</a>
  <ul class="collapse">
  <li><a href="#taylor-series-and-newtons-method" id="toc-taylor-series-and-newtons-method" class="nav-link" data-scroll-target="#taylor-series-and-newtons-method"><span class="header-section-number">3.1</span> Taylor series and Newton’s method</a></li>
  <li><a href="#derivatives-of-multivariate-functions" id="toc-derivatives-of-multivariate-functions" class="nav-link" data-scroll-target="#derivatives-of-multivariate-functions"><span class="header-section-number">3.2</span> Derivatives of multivariate functions</a></li>
  <li><a href="#multivariate-gradient-descent" id="toc-multivariate-gradient-descent" class="nav-link" data-scroll-target="#multivariate-gradient-descent"><span class="header-section-number">3.3</span> Multivariate gradient descent</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">4</span> Summary</a></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="L4-calculus-review.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Differential calculus review</h1>
</div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author">Greg Ridgeway <a href="mailto:gridge@upenn.edu" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            University of Pennsylvania
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 16, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<!-- In terminal -->
<!-- quarto render L4-calculus-review.qmd -->
<!-- git commit L4* -m "commit message" -->
<!-- git status -->
<!-- git push -->
<section id="properties-of-derivatives" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Properties of derivatives</h1>
<p>The derivative measures the slope of the line tangent to the curve <span class="math inline">\(f(x)\)</span> at <span class="math inline">\(x\)</span>. There are a lot of online derivative calculators that will grind out the derivatives should you need to compute one. Nevertheless, it will be valuable to have some of their basic properties on hand. We will use derivatives a lot when optimizing machine learning methods.</p>
<p><span class="math display">\[
    \frac{d}{dx} f(x) = \lim_{\delta\rightarrow 0} \frac{f(x+\delta)-f(x)}{\delta}
\]</span> <span class="math display">\[
\begin{split}
    \frac{d}{dx} c &amp;= 0 \\
    \frac{d}{dx} x^n &amp;= nx^{n-1} \\
    \frac{d}{dx} e^x &amp;= e^x \\
    \frac{d}{dx} \log(x) &amp;= \frac{1}{x} \\
    \frac{d}{dx} cf(x) &amp;=  c\frac{d}{dx} f(x) \\
    \frac{d}{dx} (f(x) + g(x)) &amp;=  \frac{d}{dx} f(x) + \frac{d}{dx} g(x)\\
    \frac{d}{dx} f(x)g(x) &amp;= f(x)\frac{d}{dx} g(x) + g(x)\frac{d}{dx} f(x) \mbox{  (Product rule)}\\
    \frac{d}{dx} \frac{f(x)}{g(x)} &amp;= \frac{g(x)\frac{d}{dx} f(x) - f(x)\frac{d}{dx} g(x)}{g(x)^2}\mbox{  (Quotient rule)}\\
    \frac{d}{dx} f(g(x)) &amp;=  \frac{d}{dg} f(g) \times \frac{d}{dx} g(x) \mbox{  (Chain rule)}
\end{split}
\]</span></p>
<section id="exercises" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="exercises"><span class="header-section-number">1.1</span> Exercises</h2>
<ol type="1">
<li>Example: Compute <span class="math inline">\(\frac{d}{d\beta} (y-\beta)^2\)</span></li>
</ol>
<p>Answer: Use the chain rule where <span class="math inline">\(f(g)=g^2\)</span> and <span class="math inline">\(g(\beta)=y-\beta\)</span>. <span class="math display">\[
\frac{d}{d\beta} (y-\beta)^2 = 2(y-\beta)(-1)
\]</span></p>
<ol start="2" type="1">
<li>Compute <span class="math inline">\(\frac{d}{d\beta} ((y_1-\beta)^2+(y_2-\beta)^2+(y_3-\beta)^2)\)</span></li>
<li>Compute <span class="math inline">\(\frac{d}{d\beta} \sum_{i=1}^n (y_i-\beta)^2\)</span></li>
<li>Compute <span class="math inline">\(\frac{d}{dp} \log(p) + \log(1-p)\)</span></li>
<li>Compute <span class="math inline">\(\frac{d}{dp} y\log(p) + (1-y)\log(1-p)\)</span></li>
<li>Compute <span class="math inline">\(\frac{d}{dx} |x|\)</span> (Hint: draw a picture of <span class="math inline">\(f(x)=|x|\)</span>)</li>
<li>Compute <span class="math inline">\(\frac{d}{dx} |a+bx|\)</span></li>
<li>Compute <span class="math inline">\(\frac{d}{dx} \frac{1}{1+e^{-x}}\)</span></li>
</ol>
</section>
</section>
<section id="optimization" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Optimization</h1>
<p>For smooth functions, <span class="math inline">\(f(x)\)</span>, local minima/maxima solve <span class="math display">\[
    \frac{d}{dx} f(x) = 0
\]</span> The second derivatives help us determine whether a local extreme value is a maximum or a minimum. <span class="math display">\[
\begin{split}
    \frac{d^2}{dx^2} f(x_\mathrm{max}) &amp;&lt; 0 \\    
    \frac{d^2}{dx^2} f(x_\mathrm{min}) &amp;&gt; 0    
\end{split}
\]</span></p>
<section id="quadratic" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="quadratic"><span class="header-section-number">2.1</span> Quadratic</h2>
<p>Find the minimum/maximum for the <span class="math inline">\(f(x)=ax^2+bx+c\)</span>.</p>
<p><span class="math display">\[
\begin{split}
\frac{d}{dx} f(x) &amp;= 2ax+b \\
2a\hat x+b&amp;=0 \\
\hat x&amp;=-\frac{b}{2a}
\end{split}
\]</span> Is it a maximum or a minimum? <span class="math display">\[
\begin{split}
\frac{d^2}{dx^2} f(x) &amp;= 2a
\end{split}
\]</span> It is a maximum if <span class="math inline">\(a&lt;0\)</span> and a minimum if <span class="math inline">\(a&gt;0\)</span>.</p>
</section>
<section id="minimize-squared-differences-with-three-values" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="minimize-squared-differences-with-three-values"><span class="header-section-number">2.2</span> Minimize squared differences with three values</h2>
<p>Assume we have three numbers, <span class="math inline">\(x_1,x_2,x_3\)</span>. What value of <span class="math inline">\(\mu\)</span> minimizes <span class="math display">\[
    J(\mu)=(x_1-\mu)^2+(x_2-\mu)^2+(x_3-\mu)^2
\]</span></p>
<p><span class="math display">\[
\begin{split}
    J'(\mu)&amp;=2(x_1-\mu)(-1)+2(x_2-\mu)(-1)+2(x_3-\mu)(-1)\\
    J'(\hat\mu)&amp;=0\\
    2(x_1-\hat\mu)(-1)+2(x_2-\hat\mu)(-1)+2(x_3-\hat\mu)(-1) &amp;= 0 \\
    (x_1-\hat\mu)+(x_2-\hat\mu)+(x_3-\hat\mu) &amp;= 0 \\
    x_1+x_2+x_3-3\hat\mu &amp;= 0 \\
    \hat\mu &amp;= \frac{x_1+x_2+x_3}{3}
\end{split}
\]</span></p>
</section>
<section id="minimize-squared-differences-with-n-values" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="minimize-squared-differences-with-n-values"><span class="header-section-number">2.3</span> Minimize squared differences with <span class="math inline">\(n\)</span> values</h2>
<p>Assume we have numbers, <span class="math inline">\(x_1,\ldots,x_n\)</span>. What value or <span class="math inline">\(\mu\)</span> minimizes <span class="math display">\[
    J(\mu)=\sum_{i=1}^n (x_i-\mu)^2
\]</span></p>
<p><span class="math display">\[
\begin{split}
    \frac{d}{d\mu} J(\mu)&amp;=\frac{d}{d\mu} \sum_{i=1}^n (x_i-\mu)^2 \\
    &amp;= \sum_{i=1}^n \frac{d}{d\mu} \left((x_i-\mu)^2\right) \\
    &amp;= \sum_{i=1}^n 2(x_i-\mu)(-1) \\
    \left.\frac{d}{d\mu} J(\mu)\right\rvert_{\hat\mu}&amp;=0\\
    \sum_{i=1}^n 2(x_i-\hat\mu)(-1) &amp;= 0 \\
    -2\sum_{i=1}^n (x_i-\hat\mu) &amp;= 0 \\
    \sum_{i=1}^n x_i-n\hat\mu &amp;= 0 \\
    \hat\mu &amp;= \frac{\sum_{i=1}^n x_i}{n}
\end{split}
\]</span></p>
</section>
<section id="estimating-a-probability" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="estimating-a-probability"><span class="header-section-number">2.4</span> Estimating a probability</h2>
<p>We have random variables <span class="math inline">\(Y_1,\ldots,Y_n\)</span> that are all either 0 or 1. They are all independent and have the same probability of equaling 1, <span class="math inline">\(P(Y_i=1)=p\)</span>. These are commonly called Bernoulli random variables. The probability function for Bernoulli random variable is <span class="math inline">\(P(Y=y)=p^y(1-p)^{1-y}\)</span>.</p>
<p>If <span class="math inline">\(p\)</span> is fixed but unknown, what is the probability of observing the sequence <span class="math inline">\(y_1,\ldots,y_n\)</span>? This is known as the likelihood function for <span class="math inline">\(p\)</span>. <span class="math display">\[
\begin{split}
   L(p) &amp;= P(Y_1=y_1,\ldots,Y_n=y_n) \\
        &amp;= P(Y_1=y_1)\cdots P(Y_n=y_n) \\
        &amp;= p^{y_1}(1-p)^{1-y_1}\cdots p^{y_n}(1-p)^{1-y_n} \\
        &amp;= p^{y_1+\ldots+y_n}(1-p)^{1-y_1+\ldots+1-y_n} \\
        &amp;= p^{\sum y_i} (1-p)^{n-\sum y_i}
\end{split}
\]</span> This function is a little difficult to optimize. Conveniently, if <span class="math inline">\(\hat p\)</span> optimizes <span class="math inline">\(L(p)\)</span> then <span class="math inline">\(\hat p\)</span> will also optimize <span class="math inline">\(\log L(p)=\ell(p)\)</span>. <span class="math display">\[
\begin{split}
    \ell(p) &amp;= \log L(p) \\
        &amp;= \log \left( p^{\sum y_i} (1-p)^{n-\sum y_i} \right) \\
        &amp;= \left(\sum y_i\right) \log(p) + \left(n-\sum y_i\right)\log(1-p) \\
    \ell'(p) &amp;= \left(\sum y_i\right) \frac{1}{p} - \left(n-\sum y_i\right)\frac{1}{1-p}
\end{split}
\]</span> Find <span class="math inline">\(\hat p\)</span> that solves <span class="math inline">\(\ell'(p)=0\)</span>. <span class="math display">\[
\begin{split}
    0 &amp;= \ell'(\hat p) \\
    &amp;= \left(\sum y_i\right) \frac{1}{\hat p} - \left(n-\sum y_i\right)\frac{1}{1-\hat p} \\
    &amp;= \left(\sum y_i\right) (1-\hat p) - \left(n-\sum y_i\right)\hat p\\
    &amp;= \left(\sum y_i\right) - \hat p\left(\sum y_i\right) - n\hat p+\left(\sum y_i\right)\hat p\\
    \hat p &amp;= \frac{\sum y_i}{n}
\end{split}
\]</span> This shows that the maximum likelihood estimator for <span class="math inline">\(p\)</span> is the sample mean of the <span class="math inline">\(y_i\)</span>s, the same as the commonsense estimate that you would have used.</p>
</section>
<section id="exercises-1" class="level2" data-number="2.5">
<h2 data-number="2.5" class="anchored" data-anchor-id="exercises-1"><span class="header-section-number">2.5</span> Exercises</h2>
<ol type="1">
<li>Find <span class="math inline">\(\hat x\)</span> that optimizes <span class="math inline">\(f(x)=2x+\frac{200}{x}\)</span>. Is it a maximum or a minimum?</li>
<li>Find <span class="math inline">\(\hat x\)</span> that optimizes <span class="math inline">\(f(x)=\log(x)+\log(1-x)+3\)</span>. Is it a maximum or a minimum?</li>
<li>Find <span class="math inline">\(\hat t\)</span> that optimizes <span class="math inline">\(f(x)=100+\frac{800t}{t^2+90000}\)</span>. Is it a maximum or a minimum?</li>
<li>Find <span class="math inline">\(\hat p\)</span> that optimizes <span class="math inline">\(\ell(p)=6\log(p)+10\log(1-p)\)</span>. Is it a maximum or a minimum?</li>
</ol>
</section>
</section>
<section id="gradient-descent" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Gradient descent</h1>
<p>Often we will not be able to directly solve <span class="math inline">\(\frac{d}{dx} f(x) = 0\)</span>. The best we can do is figure out how to move a guess for the optimal value of <span class="math inline">\(x\)</span> toward the optimal value. Let’s simulate some data where <span class="math inline">\(x\)</span> are a bunch of random standard normal values and <span class="math inline">\(y=\frac{1}{1+\exp(-3x)}\)</span> and we will let <span class="math inline">\(J\)</span> be squared error.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">100</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span><span class="dv">3</span><span class="sc">*</span>x))</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># squared error</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>J <span class="ot">&lt;-</span> <span class="cf">function</span>(b, x, y)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  yhat <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span>b<span class="sc">*</span>x))</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>( <span class="fu">sum</span>((y<span class="sc">-</span>yhat)<span class="sc">^</span><span class="dv">2</span>) )</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># derivative of J with respect to b</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>dJ <span class="ot">&lt;-</span> <span class="cf">function</span>(b, x, y)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  yhat <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">+</span><span class="fu">exp</span>(<span class="sc">-</span>b<span class="sc">*</span>x))</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>( <span class="fu">sum</span>(<span class="sc">-</span><span class="dv">2</span><span class="sc">*</span>(y<span class="sc">-</span>yhat)<span class="sc">*</span>yhat<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>yhat)<span class="sc">*</span>x) )</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">20</span>, <span class="at">length.out=</span><span class="dv">100</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>J0 <span class="ot">&lt;-</span> <span class="fu">sapply</span>(b, <span class="cf">function</span>(beta0) <span class="fu">J</span>(beta0,x,y))</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(b,J0, <span class="at">type=</span><span class="st">"l"</span>, <span class="at">xlab=</span><span class="fu">expression</span>(<span class="fu">hat</span>(beta)), <span class="at">ylab=</span><span class="fu">expression</span>(<span class="fu">J</span>(<span class="fu">hat</span>(beta))))</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">6</span>),<span class="fu">c</span>(<span class="fu">J</span>(<span class="dv">1</span>,x,y),<span class="fu">J</span>(<span class="dv">6</span>,x,y)))</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">curve</span>(<span class="fu">dJ</span>(<span class="dv">1</span>,x,y)<span class="sc">*</span>(b<span class="dv">-1</span>) <span class="sc">+</span> <span class="fu">J</span>(<span class="dv">1</span>,x,y), <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">col =</span> <span class="st">'blue'</span>, <span class="at">xname=</span><span class="st">"b"</span>,</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">from=</span><span class="dv">0</span>,<span class="at">to=</span><span class="fl">1.6</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="fu">curve</span>(<span class="fu">dJ</span>(<span class="dv">6</span>,x,y)<span class="sc">*</span>(b<span class="dv">-6</span>) <span class="sc">+</span> <span class="fu">J</span>(<span class="dv">6</span>,x,y), <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">col =</span> <span class="st">'blue'</span>, <span class="at">xname=</span><span class="st">"b"</span>,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">from=</span><span class="dv">2</span>,<span class="at">to=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-curveWithSlopes" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-curveWithSlopes-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="L4-calculus-review_files/figure-html/fig-curveWithSlopes-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-curveWithSlopes-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: An example <span class="math inline">\(J(\beta)\)</span> showing tangent lines at two points
</figcaption>
</figure>
</div>
</div>
</div>
<p>Consider <a href="#fig-curveWithSlopes" class="quarto-xref">Figure&nbsp;1</a>. Here we have a loss function that has its minimum around <span class="math inline">\(\hat\beta=3\)</span> (as it should since we simulated it to be so). If we evaluate the derivative at <span class="math inline">\(\hat\beta=6\)</span>, then we get a positive slope, telling us that the optimal <span class="math inline">\(\beta\)</span> is smaller than 6. If we evaluate the derivative at <span class="math inline">\(\hat\beta=1\)</span>, then we get a negative slope, telling us that the optimal <span class="math inline">\(\hat\beta\)</span> is larger.</p>
<p>This suggests an optimization process that iteratively adjusts our guess for the optimal <span class="math inline">\(\hat\beta\)</span> as <span class="math display">\[
    \hat\beta \leftarrow \hat\beta - \lambda J'(\hat\beta)
\]</span> where <span class="math inline">\(\lambda\)</span> is a small value representing a “step size” or a “learning rate”.</p>
<section id="taylor-series-and-newtons-method" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="taylor-series-and-newtons-method"><span class="header-section-number">3.1</span> Taylor series and Newton’s method</h2>
<p>For any well-behaved function (smooth, with derivatives), Taylor series approximations can come in handy.</p>
<div id="thm-line" class="theorem">
<p><span class="theorem-title"><strong>Theorem 1 (Taylor’s Theorem)</strong></span> <span class="math display">\[
J(x) = J(x_0) + J'(x_0)(x-x_0) + \frac{1}{2}J''(x_0)(x-x_0)^2 + \ldots + \frac{1}{n!}J^{(n)}(x_0)(x-x_0)^n + \ldots
\]</span></p>
</div>
<p>Typically, we will just use the series up to the quadratic term to approximate <span class="math inline">\(J\)</span>s that are hard to analyze otherwise. Let’s say that we have a <span class="math inline">\(J(x)\)</span> that we want to optimize, but our algebra tricks do not help us figure out its optimal value. A quadratic Taylor series approximation is <span class="math display">\[
    J(x)\approx J(x_0)+J'(x_0)(x-x_0)+\frac{1}{2}J''(x_0)(x-x_0)^2
\]</span> If we have a starting value, <span class="math inline">\(x_0\)</span>, then we can optimize the right-hand side to find a new candidate for the optimal value. If we take a derivative with respect to <span class="math inline">\(x\)</span> (not <span class="math inline">\(x_0\)</span>!) we arrive at <span class="math display">\[
    J'(x)\approx J'(x_0) + J''(x_0)(x-x_0)
\]</span> Now let’s find an <span class="math inline">\(x\)</span> that optimizes this expression. <span id="eq-newton"><span class="math display">\[
\begin{split}
    J'(x_0) + J''(x_0)(\hat x-x_0) &amp;= 0 \\
    \hat x &amp;= x_0 - \frac{J'(x_0)}{J''(x_0)}
\end{split}
\tag{1}\]</span></span> This implies that if we have a guess, <span class="math inline">\(x_0\)</span>, for the optimal value, then we should be able to get a better guess by calculating (<a href="#eq-newton" class="quarto-xref">1</a>). We will need to repeat this several times until it converges on a final answer. This is known as Newton’s method.</p>
<p><strong>Example</strong> In a previous exercise we optimized <span class="math inline">\(\ell(p)=6\log(p)+10\log(1-p)\)</span> directly. Let’s pretend it was too hard and try Newton’s method on this one instead. <span class="math display">\[
\begin{split}
    \ell(p) &amp;= 6\log(p)+10\log(1-p) \\
    \ell'(p) &amp;= \frac{6}{p}-\frac{10}{1-p} \\
    \ell''(p) &amp;= -\frac{6}{p^2}-\frac{10}{(1-p)^2} \\
    \hat p &amp;= p_0 - \frac{\ell'(p_0)}{\ell''(p_0)} \\
     &amp;= p_0 - \frac{\frac{6}{p_0}-\frac{10}{1-p_0}}
                    {-\frac{6}{p_0^2}-\frac{10}{(1-p_0)^2}} \\
     &amp;= p_0 + \frac{p_0(1-p_0)(3-8p_0)}
                    {3-6p_0+8p_0^2}
\end{split}
\]</span> There are plenty of examples where Newton’s method does not work well (slow to converge) or at all (diverges or converges to a local maximum/minimum). For example, if we started with <span class="math inline">\(p_0=0\)</span> or <span class="math inline">\(p_0=1\)</span>, then for this problem <span class="math inline">\(\hat p\)</span> would get stuck at 0 or 1 and never move to a better value. Also note that if we started at <span class="math inline">\(p_0=\frac{3}{8}\)</span> then it also does not change, but that is because <span class="math inline">\(\frac{3}{8}\)</span> is the right answer!</p>
<p>Running this in R shows that it converges to the exact answer in just a few steps</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># newton iterations</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> p <span class="sc">+</span> p<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>p)<span class="sc">*</span>(<span class="dv">3-8</span><span class="sc">*</span>p)<span class="sc">/</span>(<span class="dv">3-6</span><span class="sc">*</span>p<span class="sc">+</span><span class="dv">8</span><span class="sc">*</span>p<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1798387
[1] 0.2854885
[1] 0.3608183
[1] 0.3747613
[1] 0.3749999
[1] 0.375</code></pre>
</div>
</div>
<p>R has built-in optimization functions that you can use for any similar optimization problem. You just need to specify the function, the first derivative (also called the gradient), and the second derivative (also called the Hessian), and then pass those functions to <code>nlm()</code>. Note that <code>nlm()</code> only solves <em>minimization</em> problems. So, if you have a maximization problem, just multiply all your functions and derivatives by -1 to make it a minimization problem.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="cf">function</span>(p)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="sc">-</span>(<span class="dv">6</span><span class="sc">*</span><span class="fu">log</span>(p)<span class="sc">+</span><span class="dv">10</span><span class="sc">*</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">-</span>p))</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attr</span>(res, <span class="st">"gradient"</span>) <span class="ot">&lt;-</span> <span class="sc">-</span>(<span class="dv">6</span><span class="sc">/</span>p <span class="sc">-</span> <span class="dv">10</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>p))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">attr</span>(res, <span class="st">"hessian"</span>)  <span class="ot">&lt;-</span> <span class="dv">6</span><span class="sc">/</span>p<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="dv">10</span><span class="sc">/</span>(<span class="dv">1</span><span class="sc">-</span>p)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">nlm</span>(f, <span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$minimum
[1] 10.58501

$estimate
[1] 0.3749999

$gradient
[1] -4.155613e-06

$code
[1] 1

$iterations
[1] 5</code></pre>
</div>
</div>
</section>
<section id="derivatives-of-multivariate-functions" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="derivatives-of-multivariate-functions"><span class="header-section-number">3.2</span> Derivatives of multivariate functions</h2>
<p>Machine learning models never have a single parameter. The latest ones in the news have trillions of parameters. We will end up optimizing functions of many parameters, so we need some tools to compute derivatives of functions with many parameters.</p>
<p>If <span class="math inline">\(J(\alpha,\beta)\)</span> then there are two <em>partial</em> derivatives <span class="math display">\[
\begin{split}
\frac{\partial}{\partial\alpha} J(\alpha,\beta) &amp;= \left.\frac{dJ}{d\alpha}\right\rvert_\beta   \\
\frac{\partial}{\partial\beta} J(\alpha,\beta) &amp;= \left.\frac{dJ}{d\beta} \right\rvert_\alpha
\end{split}
\]</span> In each of these, the parameter that is not the focus of the derivative is treated as a fixed constant.</p>
<p>We will encounter models with many parameters with derivatives requiring a rather deep level of using the chain rule, especially when we get to backpropagation in neural networks. For example, <span class="math display">\[
\begin{split}
    J(\beta_0,\beta_1,\ldots,\beta_d) &amp;= \sum_{i=1}^n (y_i-\hat y_i)^2 \\
    \hat y_i &amp;= \frac{1}{1+e^{-z_i}} \\
    z_i &amp;= \beta_0 + \beta_1x_{1i} + \ldots  + \beta_dx_{di}
\end{split}
\]</span> To figure out the “direction” to move <span class="math inline">\(\beta\)</span> in order to optimize <span class="math inline">\(J\)</span> we need to work through several levels of derivatives. <span class="math display">\[
\begin{split}
\frac{\partial J}{\partial\hat y_i} &amp;= -2(y_i-\hat y_i) \\
\frac{\partial\hat y_i}{\partial z_i} &amp;=
  \frac{e^{-z_i}}{(1+e^{-z_i})^2} =
  \frac{1}{1+e^{-z_i}}\frac{e^{-z_i}}{1+e^{-z_i}} = \hat y_i(1-\hat y_i) \\
\frac{\partial z_i}{\partial \beta_j} &amp;= x_{ji}
\end{split}
\]</span> If we want to know how changes in a particular <span class="math inline">\(\beta_j\)</span> change the value of <span class="math inline">\(J\)</span> then we chain all the derivatives together. <span class="math display">\[
\begin{split}
\frac{\partial J}{\partial\beta_j} &amp;= \frac{\partial J}{\partial\hat y_1} \frac{\partial\hat y_1}{\partial z_1} \frac{\partial z_1}{\partial \beta_j} + \ldots + \frac{\partial J}{\partial\hat y_n} \frac{\partial\hat y_n}{\partial z_n} \frac{\partial z_n}{\partial \beta_j} \\
&amp;= \sum_{i=1}^n -2(y_i-\hat y_i) \hat y_i(1-\hat y_i) x_{ji}
\end{split}
\]</span> The gradient is the collection of derivatives assembled into a single vector and is usually denoted as <span class="math inline">\(\nabla J\)</span> (spoken as “gradient of <span class="math inline">\(J\)</span>” or “del <span class="math inline">\(J\)</span>”). <span class="math display">\[
    \nabla J=\begin{bmatrix} \frac{\partial J}{\partial\beta_0} \\ \vdots \\ \frac{\partial J}{\partial\beta_d} \end{bmatrix}
\]</span></p>
</section>
<section id="multivariate-gradient-descent" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="multivariate-gradient-descent"><span class="header-section-number">3.3</span> Multivariate gradient descent</h2>
<p>The gradient “points” in the direction that we need to move our current choice of <span class="math inline">\(\beta\)</span> to optimize <span class="math inline">\(J(\beta)\)</span>. That is, if we have a current guess for <span class="math inline">\(\hat\beta\)</span>, then we can find an improved guess (one that makes <span class="math inline">\(J(\beta)\)</span> even smaller), by adjusting our guess as <span class="math display">\[
\begin{split}
    \hat\beta &amp;\leftarrow \hat\beta - \lambda\begin{bmatrix} \frac{\partial J}{\partial\beta_0} \\ \vdots \\ \frac{\partial J}{\partial\beta_d} \end{bmatrix} \\
    &amp;= \hat\beta - \lambda\nabla J    
\end{split}
\]</span> for some <span class="math inline">\(\lambda\)</span> that is sufficiently small.</p>
<p>We will get more into this when we pick up some linear algebra skills and matrix derivatives.</p>
</section>
</section>
<section id="summary" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Summary</h1>
<p>We have complete a quick review of differential calculus concepts essential for understanding optimization and machine learning algorithms.</p>
<ol type="1">
<li><strong>Properties of Derivatives</strong>:
<ul>
<li>Important derivative rules (power rule, product rule, quotient rule, chain rule)</li>
<li>Analyzed and optimized functions</li>
</ul></li>
<li><strong>Optimization</strong>:
<ul>
<li>Found local maxima and minima using first and second derivatives</li>
<li>Solved common optimization problems (minimizing squared differences, estimating probabilities for Bernoulli random variables)</li>
</ul></li>
<li><strong>Gradient Descent</strong>:
<ul>
<li>Reviewed Taylor series approximations for analyzing complex functions</li>
<li>Used gradient descent as an iterative optimization method for finding minima when direct solutions are infeasible</li>
</ul></li>
<li><strong>Multivariate Gradient Descent</strong>:
<ul>
<li>Extended calculus principles to multivariate functions, introducing partial derivatives and gradients</li>
<li>Introduced gradient descent for multivariate functions</li>
</ul></li>
</ol>
<p>One important innovation in recent decades is efficient “auto-differentiation” algorithms, “autodiff” for short. The methods can take computer code that evaluates a model’s performance and automatically write additional code to compute the gradients. These autodiff methods have become essential in scientific computing (such as Hamiltonian Markov Chain integration) and in learning neural networks. Common neural network software, like TensorFlow and PyTorch, rely on autodiff methods to efficiently compute gradients necessary for optimizing neural networks. Advances have been particularly large on using GPUs (graphical processing units) to run autodiff methods.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = true;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>